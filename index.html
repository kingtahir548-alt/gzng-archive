<!DOCTYPE html>
<html lang="ku" dir="rtl" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¦Û•Ø±Ø´ÛŒÙÛŒ Ú¯Ø²Ù†Ú¯ | Gzng Archive</title>
    <link href="https://fonts.googleapis.com/css2?family=Rudaw:wght@400;700;900&family=Noto+Sans+Arabic:wght@300;400;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --bg-body: #f0f2f5;
            --bg-glass: rgba(255, 255, 255, 0.9);
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-light: #64748b;
            --primary: #6366f1;
            --primary-gradient: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            --shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.1);
            --border: 1px solid rgba(255, 255, 255, 0.6);
            --radius: 16px;
        }

        [data-theme="dark"] {
            --bg-body: #0f172a;
            --bg-glass: rgba(30, 41, 59, 0.85);
            --bg-card: #1e293b;
            --text-main: #f1f5f9;
            --text-light: #94a3b8;
            --primary: #818cf8;
            --primary-gradient: linear-gradient(135deg, #818cf8 0%, #6366f1 100%);
            --shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.5);
            --border: 1px solid rgba(255, 255, 255, 0.08);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { 
            font-family: 'Noto Sans Arabic', sans-serif; 
            background-color: var(--bg-body); 
            background-image: radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.1) 0px, transparent 50%), radial-gradient(at 100% 100%, rgba(168, 85, 247, 0.1) 0px, transparent 50%);
            background-attachment: fixed;
            min-height: 100vh; 
            color: var(--text-main);
            overflow-x: hidden;
            transition: background-color 0.5s ease;
            padding-top: 80px; /* Space for fixed header */
        }

        /* --- Global Components --- */
        .glass {
            background: var(--bg-glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: var(--border);
            box-shadow: var(--shadow);
        }

        button { cursor: pointer; font-family: inherit; border: none; background: none; }
        
        /* --- Modern Navbar --- */
        .navbar {
            position: fixed; top: 0; left: 0; width: 100%; z-index: 1000;
            padding: 10px 20px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: var(--border);
        }
        
        .nav-brand { font-size: 1.3em; font-weight: 900; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: flex; align-items: center; gap: 10px; }
        .logo-icon { width: 35px; height: 35px; background: var(--primary); border-radius: 10px; color: white; display: flex; align-items: center; justify-content: center; font-size: 20px; }

        .nav-menu { display: flex; gap: 5px; background: rgba(128,128,128,0.08); padding: 5px; border-radius: 50px; }
        .nav-link { 
            padding: 8px 20px; border-radius: 25px; color: var(--text-light); font-weight: bold; font-size: 0.95em; transition: 0.3s; 
            display: flex; align-items: center; gap: 6px;
        }
        .nav-link:hover { background: rgba(128,128,128,0.1); color: var(--text-main); }
        .nav-link.active { background: var(--bg-card); color: var(--primary); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }

        .nav-tools { display: flex; align-items: center; gap: 15px; }
        .theme-btn { font-size: 1.2em; padding: 8px; border-radius: 50%; transition: 0.3s; }
        .theme-btn:hover { background: rgba(128,128,128,0.1); transform: rotate(15deg); }

        /* Mobile Menu Adjustments */
        @media (max-width: 650px) {
            .nav-text { display: none; }
            .nav-link { padding: 10px 15px; }
        }

        /* --- Main Layout --- */
        .container { max-width: 1200px; margin: 0 auto; width: 95%; padding-bottom: 50px; }
        
        .page-header { margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }
        .page-title { font-size: 1.5em; font-weight: 800; }

        .search-bar { 
            width: 100%; max-width: 600px; margin: 0 auto 30px; position: relative; 
        }
        .search-input {
            width: 100%; padding: 16px 25px; border-radius: 50px; border: var(--border);
            background: var(--bg-card); color: var(--text-main); font-size: 1.1em;
            box-shadow: var(--shadow); transition: 0.3s;
        }
        .search-input:focus { transform: scale(1.01); border-color: var(--primary); }

        /* Cards Grid */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
        
        .card { 
            background: var(--bg-card); border-radius: 20px; overflow: hidden; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.03); border: var(--border);
            transition: 0.3s; display: flex; flex-direction: column;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
        
        .card-imgs { display: grid; grid-template-columns: 1fr 1fr; height: 180px; gap: 1px; background: #eee; }
        .card-imgs img { width: 100%; height: 100%; object-fit: cover; }
        
        .card-body { padding: 18px; flex-grow: 1; }
        .card-title { font-weight: 800; font-size: 1.1em; margin-bottom: 8px; }
        .card-meta { font-size: 0.85em; color: var(--text-light); margin-bottom: 5px; display: flex; align-items: center; gap: 8px; }
        
        .btn-view { 
            width: 100%; padding: 12px; background: rgba(99, 102, 241, 0.08); color: var(--primary); 
            font-weight: bold; margin-top: auto; border-top: 1px solid rgba(0,0,0,0.05); transition: 0.2s;
        }
        .btn-view:hover { background: var(--primary); color: white; }

        /* Teachers List */
        .teacher-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .t-card { 
            background: var(--bg-card); padding: 20px; border-radius: 20px; text-align: center; 
            border: var(--border); transition: 0.3s; cursor: pointer;
        }
        .t-card:hover { border-color: var(--primary); transform: translateY(-3px); }
        .t-avatar { width: 70px; height: 70px; border-radius: 50%; margin: 0 auto 10px; object-fit: cover; border: 2px solid var(--primary); padding: 2px; background: var(--bg-body); }

        /* Add Button (Floating) */
        .fab {
            position: fixed; bottom: 30px; left: 30px; width: 60px; height: 60px;
            background: var(--primary-gradient); color: white; border-radius: 50%;
            display: none; align-items: center; justify-content: center; font-size: 24px;
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.4); z-index: 900; transition: 0.3s;
        }
        .fab:hover { transform: scale(1.1) rotate(90deg); }

        /* Admin Dashboard (Full Page Overlay) */
        .dashboard {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-body); z-index: 2000; overflow-y: auto; display: none;
        }
        .dash-nav {
            background: #1e293b; color: white; padding: 15px 25px; 
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 10;
        }
        .dash-btn { padding: 8px 15px; background: rgba(255,255,255,0.1); border-radius: 8px; color: white; font-size: 0.9em; }
        .dash-btn:hover { background: rgba(255,255,255,0.2); }

        /* Filter Header */
        .filter-bar {
            display: none; align-items: center; justify-content: space-between;
            background: var(--bg-card); padding: 15px; border-radius: 15px;
            margin-bottom: 25px; border: var(--border); animation: fadeIn 0.3s;
        }

        /* --- Editor (Hidden Logic same as before, simplified UI) --- */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; display: none; justify-content: center; overflow-y: auto; padding: 20px; backdrop-filter: blur(5px); }
        .modal.active { display: flex; }
        .paper-view { background: #555; padding: 20px; border-radius: 15px; max-width: 1000px; width: 100%; display: flex; flex-direction: column; gap: 10px; }
        
        /* Keeping A4 Styles for Printing */
        .a4 { width: 210mm; min-height: 297mm; background: white; padding: 15mm; margin: 0 auto; color: black; direction: rtl; text-align: right; display: flex; flex-direction: column; position: relative; }
        .p-head { border-bottom: 3px solid black; padding-bottom: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .p-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #f8f9fa; padding: 10px; border: 1px solid #ddd; margin-bottom: 15px; }
        .p-inp { width: 100%; border: none; border-bottom: 1px dashed #ccc; background: transparent; font-weight: bold; }
        .p-imgs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .slot { background: #eee; border: 2px dashed #ccc; height: 180px; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .slot img { width: 100%; height: 100%; object-fit: contain; }
        .slot:hover .ctrls { opacity: 1; }
        .ctrls { position: absolute; bottom: 5px; display: flex; gap: 5px; opacity: 0; transition: 0.2s; }
        .c-btn { width: 25px; height: 25px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        @media print {
            body > * { display: none !important; }
            .modal { display: block !important; position: absolute !important; background: white !important; overflow: visible !important; }
            .paper-view { padding: 0 !important; background: white !important; display: block !important; }
            .a4 { box-shadow: none !important; margin: 0 !important; }
            .ctrls, .editor-tools { display: none !important; }
        }
    </style>
</head>
<body>

    <nav class="navbar glass">
        <div class="nav-brand">
            <div class="logo-icon">ğŸ«</div>
            <span class="nav-text">Ø¦Û•Ø±Ø´ÛŒÙÛŒ Ú¯Ø²Ù†Ú¯</span>
        </div>

        <div class="nav-menu">
            <button onclick="switchView('archive')" class="nav-link active" id="link-archive">
                <span>ğŸ </span> <span class="nav-text">Ø³Û•Ø±Û•Ú©ÛŒ</span>
            </button>
            <button onclick="switchView('teachers')" class="nav-link" id="link-teachers">
                <span>ğŸ‘¨â€ğŸ«</span> <span class="nav-text">Ù…Ø§Ù…Û†Ø³ØªØ§ÛŒØ§Ù†</span>
            </button>
            <button onclick="checkAdminAccess()" class="nav-link" id="link-admin">
                <span>âš™ï¸</span> <span class="nav-text">Ø¦Û•Ø¯Ù…ÛŒÙ†</span>
            </button>
        </div>

        <div class="nav-tools">
            <button onclick="toggleTheme()" class="theme-btn" id="themeIcon">ğŸŒ™</button>
        </div>
    </nav>

    <button id="fabBtn" class="fab" onclick="openEditor()">+</button>

    <div class="container" id="mainContainer">
        
        <div id="filterBar" class="filter-bar">
            <div style="display:flex; align-items:center; gap:10px;">
                <h3 id="filterTitle">Ø¦Û•Ø±Ø´ÛŒÙÛŒ Ù…Ø§Ù…Û†Ø³ØªØ§...</h3>
            </div>
            <button onclick="clearFilter()" style="color:#ef4444; font-weight:bold;">âŒ Ú¯Û•Ú•Ø§Ù†Û•ÙˆÛ•</button>
        </div>

        <div id="searchContainer" class="search-bar">
            <input type="text" id="searchBox" class="search-input" placeholder="Ú¯Û•Ú•Ø§Ù†...">
        </div>

        <div id="view-archive" class="grid"></div>
        <div id="view-teachers" class="teacher-grid" style="display:none;"></div>

    </div>

    <div id="adminDashboard" class="dashboard">
        <div class="dash-nav">
            <h2>Ø¨Û•Ú•ÛÙˆÛ•Ø¨Ø±Ø¯Ù†</h2>
            <button onclick="closeAdmin()" class="dash-btn" style="background:#3b82f6;">ğŸ”™ Ú¯Û•Ú•Ø§Ù†Û•ÙˆÛ• Ø¨Û† Ø³Ø§ÛŒØª</button>
        </div>
        <div class="container" style="padding-top: 20px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3>Ù„ÛŒØ³ØªÛŒ Ù‡Û•Ù…ÙˆÙˆ Ú†Ø§Ù„Ø§Ú©ÛŒÛŒÛ•Ú©Ø§Ù†</h3>
                <button onclick="logoutAdmin()" style="color:#ef4444; font-weight:bold;">Ú†ÙˆÙˆÙ†Û• Ø¯Û•Ø±Û•ÙˆÛ•</button>
            </div>
            <div class="glass" style="padding:20px; border-radius:15px;">
                <table style="width:100%; border-collapse:collapse;">
                    <thead><tr style="text-align:right; color:var(--text-light);"><th>Ø¨Ø§Ø¨Û•Øª</th><th>Ù…Ø§Ù…Û†Ø³ØªØ§</th><th>Ú©Ø±Ø¯Ø§Ø±</th></tr></thead>
                    <tbody id="adminTableBody"></tbody>
                </table>
            </div>
            <div style="margin-top:30px;">
                <h3>Ù…Ø§Ù…Û†Ø³ØªØ§ÛŒØ§Ù†</h3>
                <button onclick="openTeacherModal()" style="margin:10px 0; color:var(--primary); font-weight:bold;">â• Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†ÛŒ Ù…Ø§Ù…Û†Ø³ØªØ§</button>
                <div id="adminTeacherList" class="teacher-grid"></div>
            </div>
        </div>
    </div>

    <div id="editorModal" class="modal">
        <div class="paper-view">
            <div class="editor-tools" style="display:flex; justify-content:space-between; background:white; padding:10px; border-radius:10px; margin-bottom:10px;">
                <div>
                    <button onclick="closeEditor()" style="color:red; font-weight:bold;">Ø¯Ø§Ø®Ø³ØªÙ†</button>
                </div>
                <div style="display:flex; gap:10px;">
                    <button onclick="window.print()">ğŸ–¨ï¸</button>
                    <button onclick="saveToArchive()" id="btnSave" style="color:blue; font-weight:bold; display:none;">ğŸ’¾ Ø³Û•ÛŒÚ¤</button>
                </div>
            </div>
            
            <div class="a4" id="reportPaper">
                <div class="p-head">
                    <div><h1>Ù‚ÙˆØªØ§Ø¨Ø®Ø§Ù†Û•ÛŒ Ú¯Ø²Ù†Ú¯</h1><p>ÙÛ†Ø±Ù…ÛŒ Ú•Ø§Ù¾Û†Ø±Øª</p></div>
                    <div style="width:50px; height:50px; background:#eee; border-radius:50%; display:flex; align-items:center; justify-content:center;">L</div>
                </div>
                <div class="p-grid">
                    <div><label>Ø¨Ø§Ø¨Û•Øª</label><input id="inpName" class="p-inp"></div>
                    <div><label>Ù„ÛŒÚ˜Ù†Û•</label><input id="inpComm" class="p-inp"></div>
                    <div><label>Ù…Ø§Ù…Û†Ø³ØªØ§</label><select id="inpTeacher" class="p-inp" style="background:white;"></select></div>
                    <div><label>Ø¨Û•Ø±ÙˆØ§Ø±</label><input id="inpDate" type="date" class="p-inp"></div>
                </div>
                <textarea id="inpNotes" style="width:100%; height:100px; border:1px solid #ddd; margin-bottom:10px; padding:5px;"></textarea>
                <div class="p-imgs" id="imgGrid">
                    </div>
                <div style="margin-top:auto; text-align:center; font-size:12px; color:#777; border-top:1px solid #eee; padding-top:5px;">Ù‚ÙˆØªØ§Ø¨Ø®Ø§Ù†Û•ÛŒ Ú¯Ø²Ù†Ú¯</div>
            </div>
        </div>
    </div>

    <input type="file" id="hiddenFile" style="display:none;" accept="image/*">
    
    <div id="loginModal" class="modal" style="align-items:center;">
        <div class="glass" style="padding:30px; background:white; border-radius:15px; width:300px; text-align:center;">
            <h3>Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•ÛŒ Ø¦Û•Ø¯Ù…ÛŒÙ†</h3>
            <input id="admEmail" placeholder="Ø¦ÛŒÙ…Û•ÛŒÚµ" style="width:100%; padding:10px; margin:10px 0; border:1px solid #ddd; border-radius:5px;">
            <input id="admPass" type="password" placeholder="Ù¾Ø§Ø³Û†Ø±Ø¯" style="width:100%; padding:10px; margin-bottom:20px; border:1px solid #ddd; border-radius:5px;">
            <button onclick="doLogin()" style="background:var(--primary); color:white; padding:10px; width:100%; border-radius:5px;">Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•</button>
            <button onclick="document.getElementById('loginModal').classList.remove('active')" style="margin-top:10px; color:#666;">Ø¯Ø§Ø®Ø³ØªÙ†</button>
        </div>
    </div>

    <div id="newTModal" class="modal" style="align-items:center;">
        <div class="glass" style="padding:20px; background:white; border-radius:15px; width:300px;">
            <input id="newTName" placeholder="Ù†Ø§ÙˆÛŒ Ù…Ø§Ù…Û†Ø³ØªØ§" style="width:100%; padding:10px; border:1px solid #ddd; margin-bottom:10px;">
            <button onclick="addNewTeacher()" style="background:blue; color:white; width:100%; padding:10px;">Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†</button>
            <button onclick="document.getElementById('newTModal').classList.remove('active')" style="width:100%; margin-top:5px;">Ø¯Ø§Ø®Ø³ØªÙ†</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy, updateDoc, where } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        
        const IMGBB_API_KEY = "0792200cd18a10eadeeccf373d03e4f7"; 

        // !!! Ù„ÛØ±Û• Ú©Û†Ø¯ÛŒ ÙØ§ÛŒÛ•Ø±Ø¨Û•ÛŒØ³ Ø¯Ø§Ø¨Ù†Û !!!
        const firebaseConfig = {
            apiKey: "AIzaSyAr_JHCa5BbM5RJ9KCp0IBom1rdAgVX4CM",
            authDomain: "gzng-f4273.firebaseapp.com",
            projectId: "gzng-f4273",
            storageBucket: "gzng-f4273.firebasestorage.app",
            messagingSenderId: "417779309632",
            appId: "1:417779309632:web:6ed119d26baa35822cd3a5",
            measurementId: "G-B6V0CHGQV6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const actRef = collection(db, "activities");
        const teachRef = collection(db, "teachers");

        let acts=[], teachers=[], user=null, curSlot=0;
        let imgState = {0:{s:1,x:0,y:0},1:{s:1,x:0,y:0},2:{s:1,x:0,y:0},3:{s:1,x:0,y:0}};
        let localFiles = [null,null,null,null];

        // --- THEME ---
        const setTheme=(t)=>{document.documentElement.setAttribute('data-theme',t); localStorage.setItem('theme',t); document.getElementById('themeIcon').innerText=t==='dark'?'â˜€ï¸':'ğŸŒ™';};
        window.toggleTheme=()=>{const c=localStorage.getItem('theme')==='dark'?'light':'dark'; setTheme(c);};
        setTheme(localStorage.getItem('theme')||'light');

        // --- AUTH ---
        onAuthStateChanged(auth, (u) => {
            user = u;
            document.getElementById('fabBtn').style.display = u ? 'flex' : 'none';
            document.getElementById('btnSave').style.display = u ? 'inline-block' : 'none';
            if(u && document.getElementById('loginModal').classList.contains('active')) {
                document.getElementById('loginModal').classList.remove('active');
                openAdmin();
            }
        });
        window.doLogin = async () => {
            try { await signInWithEmailAndPassword(auth, document.getElementById('admEmail').value, document.getElementById('admPass').value); }
            catch(e){ alert("Ù‡Û•ÚµÛ•: "+e.message); }
        };
        window.logoutAdmin = async () => { await signOut(auth); closeAdmin(); };
        window.checkAdminAccess = () => { if(user) openAdmin(); else document.getElementById('loginModal').classList.add('active'); };

        // --- NAVIGATION ---
        window.switchView = (view) => {
            document.getElementById('view-archive').style.display = view==='archive'?'grid':'none';
            document.getElementById('view-teachers').style.display = view==='teachers'?'grid':'none';
            document.getElementById('searchContainer').style.display = 'block';
            
            // Update Active Link
            document.querySelectorAll('.nav-link').forEach(l=>l.classList.remove('active'));
            document.getElementById('link-'+view).classList.add('active');

            if(view==='archive') {
                document.getElementById('filterBar').style.display='none';
                renderActs(acts);
            }
        };

        window.openAdmin = () => { document.getElementById('adminDashboard').style.display = 'block'; renderAdmin(); };
        window.closeAdmin = () => { document.getElementById('adminDashboard').style.display = 'none'; };

        // --- DATA & RENDER ---
        onSnapshot(query(actRef, orderBy("date", "desc")), (s) => {
            acts = s.docs.map(d=>({id:d.id, ...d.data()}));
            renderActs(acts); renderAdmin();
        });
        onSnapshot(teachRef, (s) => {
            teachers = s.docs.map(d=>({id:d.id, ...d.data()}));
            renderTeachers(); updateDropdown(); renderAdmin();
        });

        function renderActs(list) {
            document.getElementById('view-archive').innerHTML = list.map(a => `
                <div class="card">
                    <div class="card-imgs">${(a.images||[]).slice(0,4).map(u=>`<img src="${u}">`).join('')}</div>
                    <div class="card-body">
                        <div class="card-title">${a.name}</div>
                        <div class="card-meta">ğŸ“… ${a.date} | ğŸ‘¤ ${a.teacher}</div>
                        <button class="btn-view" onclick="openReport('${a.id}')">ğŸ“„ Ø¨ÛŒÙ†ÛŒÙ†ÛŒ Ú•Ø§Ù¾Û†Ø±Øª</button>
                    </div>
                </div>
            `).join('');
        }

        function renderTeachers() {
            const counts = {}; acts.forEach(a=>counts[a.teacher]=(counts[a.teacher]||0)+1);
            document.getElementById('view-teachers').innerHTML = teachers.map(t => `
                <div class="t-card" onclick="filterByT('${t.name}')">
                    <img src="${t.photo||'https://via.placeholder.com/70'}" class="t-avatar">
                    <div style="font-weight:bold;">${t.name}</div>
                    <div style="font-size:0.8em; color:gray;">${counts[t.name]||0} Ú†Ø§Ù„Ø§Ú©ÛŒ</div>
                </div>
            `).join('');
        }

        window.filterByT = (name) => {
            const list = acts.filter(a => a.teacher === name);
            switchView('archive');
            document.getElementById('searchContainer').style.display = 'none';
            document.getElementById('filterBar').style.display = 'flex';
            document.getElementById('filterTitle').innerText = `Ø¦Û•Ø±Ø´ÛŒÙÛŒ: ${name}`;
            renderActs(list);
        };
        window.clearFilter = () => { switchView('archive'); };
        
        document.getElementById('searchBox').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const list = acts.filter(a => a.name.toLowerCase().includes(term) || a.teacher.toLowerCase().includes(term));
            renderActs(list);
        });

        // --- ADMIN PANEL ---
        function renderAdmin() {
            if(!user) return;
            document.getElementById('adminTableBody').innerHTML = acts.map(a => `
                <tr style="border-bottom:1px solid #eee;">
                    <td style="padding:10px;">${a.name}</td>
                    <td>${a.teacher}</td>
                    <td><button onclick="delItem('${a.id}')" style="color:red;">ğŸ—‘ï¸</button></td>
                </tr>
            `).join('');
            
            document.getElementById('adminTeacherList').innerHTML = teachers.map(t => `
                <div class="t-card">
                    <div>${t.name}</div>
                    <button onclick="delTeach('${t.id}')" style="color:red; margin-top:5px;">ğŸ—‘ï¸</button>
                </div>
            `).join('');
        }
        window.delItem = async(id) => { if(confirm("Ø³Ú•ÛŒÙ†Û•ÙˆÛ•ØŸ")) await deleteDoc(doc(db, "activities", id)); };
        window.delTeach = async(id) => { if(confirm("Ø³Ú•ÛŒÙ†Û•ÙˆÛ•ØŸ")) await deleteDoc(doc(db, "teachers", id)); };
        window.openTeacherModal = () => document.getElementById('newTModal').classList.add('active');
        window.addNewTeacher = async() => {
            const n = document.getElementById('newTName').value;
            if(n) await addDoc(teachRef, {name:n, photo:""});
            document.getElementById('newTModal').classList.remove('active');
        };

        // --- REPORT EDITOR ---
        window.openEditor = () => {
            resetEditor();
            document.getElementById('editorModal').classList.add('active');
            enableInputs(true);
        };
        window.closeEditor = () => document.getElementById('editorModal').classList.remove('active');
        
        window.openReport = (id) => {
            resetEditor();
            const a = acts.find(x=>x.id===id);
            document.getElementById('inpName').value = a.name;
            document.getElementById('inpComm').value = a.committee||'';
            document.getElementById('inpTeacher').value = a.teacher;
            document.getElementById('inpDate').value = a.date;
            document.getElementById('inpNotes').value = a.notes||'';
            for(let i=0; i<4; i++) {
                if(a.images && a.images[i]) document.getElementById('img'+i).src = a.images[i];
            }
            document.getElementById('editorModal').classList.add('active');
            enableInputs(!!user);
        };

        function resetEditor() {
            ['inpName','inpComm','inpTeacher','inpDate','inpNotes'].forEach(id=>document.getElementById(id).value='');
            document.getElementById('inpDate').value = new Date().toISOString().split('T')[0];
            updateDropdown();
            localFiles=[null,null,null,null];
            
            // Build Slots
            document.getElementById('imgGrid').innerHTML = [0,1,2,3].map(i => `
                <div class="slot" id="slot${i}" onmousedown="dragStart(event,${i})" ontouchstart="dragStart(event,${i})">
                    <img id="img${i}">
                    <div class="ctrls">
                        <div class="c-btn" onclick="pickFile(${i})">ğŸ“‚</div>
                        <div class="c-btn" onclick="zoom(${i},0.1)">+</div>
                        <div class="c-btn" onclick="zoom(${i},-0.1)">-</div>
                    </div>
                </div>
            `).join('');
        }

        function updateDropdown(){
            const s = document.getElementById('inpTeacher'); s.innerHTML='<option value="">Ù‡Û•ÚµØ¨Ú˜ÛØ±Û•...</option>';
            teachers.forEach(t => {const o=document.createElement('option'); o.value=t.name; o.text=t.name; s.appendChild(o)});
        }
        function enableInputs(ok) {
            ['inpName','inpComm','inpTeacher','inpDate','inpNotes'].forEach(id=>document.getElementById(id).disabled=!ok);
            document.getElementById('btnSave').style.display = ok?'inline-block':'none';
            document.querySelectorAll('.ctrls').forEach(c=>c.style.display=ok?'flex':'none');
        }

        // --- EDITOR ACTIONS (UPLOAD/DRAG) ---
        async function upload(f){const d=new FormData();d.append("image",f); const r=await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`,{method:"POST",body:d}); const j=await r.json(); return j.data.url;}
        
        window.saveToArchive = async () => {
            const n = document.getElementById('inpName').value;
            const t = document.getElementById('inpTeacher').value;
            if(!n || !t) return alert("Ø²Ø§Ù†ÛŒØ§Ø±ÛŒ Ú©Û•Ù…Û•");
            alert("Ú†Ø§ÙˆÛ•Ú•Û Ø¨Û•...");
            const urls = [];
            for(let i=0; i<4; i++) if(localFiles[i]) urls.push(await upload(localFiles[i]));
            await addDoc(actRef, {
                name:n, committee:document.getElementById('inpComm').value, teacher:t,
                date:document.getElementById('inpDate').value, notes:document.getElementById('inpNotes').value,
                images:urls, createdAt:new Date()
            });
            alert("ØªÛ•ÙˆØ§Ùˆ"); closeEditor();
        };

        window.pickFile = (i) => { if(document.getElementById('inpName').disabled)return; curSlot=i; document.getElementById('hiddenFile').click(); };
        document.getElementById('hiddenFile').addEventListener('change', (e)=>{
            const f=e.target.files[0]; if(f){ localFiles[curSlot]=f; const r=new FileReader(); r.onload=ev=>document.getElementById('img'+curSlot).src=ev.target.result; r.readAsDataURL(f); }
        });

        // Minified Drag/Zoom
        let isD=false,aI=0,sX=0,sY=0,iX=0,iY=0;
        window.dragStart=(e,i)=>{if(document.getElementById('inpName').disabled)return; isD=true; aI=i; const c=e.touches?e.touches[0]:e; sX=c.clientX; sY=c.clientY; iX=imgState[i].x; iY=imgState[i].y;};
        window.addEventListener('mousemove',e=>{if(!isD)return; e.preventDefault(); upD(e.clientX-sX,e.clientY-sY)});
        window.addEventListener('touchmove',e=>{if(!isD)return; upD(e.touches[0].clientX-sX,e.touches[0].clientY-sY)},{passive:false});
        window.addEventListener('mouseup',()=>isD=false); window.addEventListener('touchend',()=>isD=false);
        function upD(dx,dy){const s=imgState[aI]; s.x=iX+dx; s.y=iY+dy; tr(aI);}
        window.zoom=(i,v)=>{imgState[i].s=Math.max(0.1,imgState[i].s+v); tr(i);}
        function tr(i){const s=imgState[i]; document.getElementById('img'+i).style.transform=`translate(${s.x}px,${s.y}px) scale(${s.s})`;}
    </script>
</body>
</html>
