<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø³ÛŒØ³ØªÛ•Ù…ÛŒ Ú•Ø§Ù¾Û†Ø±Øª Ùˆ Ø¦Û•Ø±Ø´ÛŒÙÛŒ Ú¯Ø²Ù†Ú¯</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #4f46e5; --bg-color: #f3f4f6; --card-bg: #ffffff;
            --text-dark: #1e293b; --text-gray: #64748b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Noto Sans Arabic', sans-serif; background-color: var(--bg-color); min-height: 100vh; padding: 10px; color: var(--text-dark); }
        
        .container { max-width: 1200px; margin: 0 auto; padding-bottom: 80px; display: none; }
        header { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; margin-bottom: 20px; position: relative; }
        h1 { font-size: 1.5em; margin-bottom: 5px; font-weight: 900; color: var(--primary); }
        
        .nav-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .tab-btn { background: white; border: 1px solid #ddd; padding: 8px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; font-family: inherit; transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        .controls { background: white; padding: 15px; border-radius: 16px; margin-bottom: 20px; display: flex; flex-direction: column; gap: 10px; }
        .search-box { padding: 12px; border-radius: 10px; border: 1px solid #ddd; font-family: inherit; width: 100%; }
        
        .buttons-row { display: flex; gap: 10px; flex-wrap: wrap; }
        
        .add-btn { 
            flex: 1; border: none; padding: 12px 20px; border-radius: 10px; 
            font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; 
            color: white; font-family: 'Noto Sans Arabic'; font-size: 0.95em;
        }
        .btn-upload { background: linear-gradient(135deg, var(--primary), #4338ca); }
        .btn-link { background: linear-gradient(135deg, #059669, #047857); }

        /* Grid System */
        .activities-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .teachers-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }

        .activity-card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: 0.3s; }
        .activity-card:hover { transform: translateY(-5px); }
        .card-header { padding: 15px; border-bottom: 1px solid #eee; }
        .card-header h3 { font-size: 1.1em; margin-bottom: 5px; }
        .card-meta { font-size: 0.85em; color: var(--text-gray); display: flex; justify-content: space-between; }
        .card-imgs { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1px; height: 180px; overflow: hidden; background: #eee; }
        .card-imgs img { width: 100%; height: 100%; object-fit: cover; }
        .card-actions { padding: 10px; display: flex; gap: 10px; background: #fafafa; }
        
        /* Teacher Card Styling */
        .teacher-card { background: white; border-radius: 20px; padding: 20px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative; overflow: hidden; transition: 0.3s; border: 2px solid transparent; cursor: pointer; }
        .teacher-card:hover { border-color: var(--primary); transform: translateY(-5px); }
        .teacher-img-wrapper { width: 100px; height: 100px; border-radius: 50%; margin: 0 auto 15px; overflow: hidden; border: 3px solid #e0e7ff; position: relative; }
        .teacher-img { width: 100%; height: 100%; object-fit: cover; }
        .teacher-placeholder { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #e0e7ff; font-size: 40px; color: var(--primary); }
        .teacher-name { font-size: 1.2em; font-weight: 900; margin-bottom: 5px; }
        .teacher-stats { font-size: 0.9em; color: var(--text-gray); background: #f1f5f9; padding: 5px 10px; border-radius: 20px; display: inline-block; }
        
        .teacher-admin-controls { 
            display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; 
            gap: 10px; justify-content: center;
        }
        .btn-icon { width: 35px; height: 35px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.1em; transition: 0.2s; }
        .btn-edit-photo { background: #dbeafe; color: #2563eb; }
        .btn-delete-teacher { background: #fee2e2; color: #ef4444; }

        .action-btn { flex: 1; padding: 8px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-family: inherit; font-size: 0.9em; }
        .btn-view { background: #e0e7ff; color: var(--primary); }
        .btn-del { background: #fee2e2; color: #ef4444; display: none; }

        /* Modals */
        .editor-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8fafc; z-index: 2000; overflow-y: auto; }
        .editor-modal.active { display: block; }
        
        .simple-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2500; justify-content: center; align-items: center; padding: 20px; }
        .simple-modal.active { display: flex; }
        .simple-modal-content { background: white; padding: 25px; border-radius: 15px; width: 100%; max-width: 400px; text-align: center; }

        .editor-header { background: white; padding: 15px; position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .editor-tools { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .tool-btn { padding: 8px 15px; border-radius: 8px; border: 1px solid #ddd; background: white; cursor: pointer; font-family: inherit; font-weight: bold; font-size: 0.9em; white-space: nowrap; }
        .tool-btn.primary { background: var(--primary); color: white; border-color: var(--primary); }
        .tool-btn.danger { background: white; color: #ef4444; border-color: #ef4444; }
        .tool-btn.active-mode { background: #dcfce7; border-color: #22c55e; color: #15803d; }

        .paper-wrapper { padding: 20px; display: flex; justify-content: center; }
        .a4-paper { 
            width: 210mm; min-height: 297mm; background: white; padding: 15mm; 
            box-shadow: 0 0 20px rgba(0,0,0,0.1); position: relative; 
            color: black; direction: rtl; text-align: right; 
            display: flex; flex-direction: column;
        }
        
        @media print {
            body * { visibility: hidden; }
            .editor-modal, .editor-modal * { visibility: visible; }
            .editor-header, .editor-tools, .link-inputs-container { display: none !important; }
            .paper-wrapper { padding: 0; margin: 0; }
            .a4-paper { box-shadow: none; width: 100%; height: 100%; margin: 0; padding: 15mm; page-break-after: always; }
            .img-placeholder span { display: none; }
        }

        /* Report styles */
        .rep-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #333; padding-bottom: 15px; margin-bottom: 20px; }
        .rep-logo { width: 70px; height: 70px; background: #f3f4f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid #ddd; }
        .rep-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; background: #f8fafc; padding: 15px; border-radius: 10px; border: 1px solid #e2e8f0; }
        .form-item label { display: block; font-size: 0.8em; color: #64748b; margin-bottom: 3px; }
        .form-input { width: 100%; border: none; background: transparent; font-family: inherit; font-weight: bold; font-size: 1em; border-bottom: 1px dashed #cbd5e1; padding: 2px; }
        .form-input:focus { outline: none; border-bottom-color: var(--primary); }
        .rep-images { display: grid; gap: 10px; margin-bottom: 20px; }
        .layout-landscape { grid-template-columns: 1fr 1fr; }
        .layout-landscape .img-slot { aspect-ratio: 16/9; }
        .layout-portrait { grid-template-columns: 1fr 1fr; }
        .layout-portrait .img-slot { aspect-ratio: 3/4; }
        .img-slot { background: #f1f5f9; border: 2px dashed #cbd5e1; border-radius: 10px; overflow: hidden; position: relative; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .img-slot:hover, .img-slot.drag-over { background: #e2e8f0; border-color: var(--primary); }
        .img-slot img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .img-slot.has-img img { display: block; }
        .img-slot.has-img .placeholder-text { display: none; }
        .placeholder-text { color: #94a3b8; font-size: 0.9em; text-align: center; pointer-events: none; }
        .rep-notes { margin-top: 10px; flex-grow: 1; }
        .rep-notes textarea { width: 100%; border: 1px solid #e2e8f0; border-radius: 10px; padding: 10px; font-family: inherit; resize: none; min-height: 200px; background: #fffbeb; font-size: 16px; line-height: 1.6; }
        .rep-footer { margin-top: auto; padding-top: 20px; text-align: center; border-top: 1px solid #eee; }
        .school-name-footer { font-size: 14px; font-weight: bold; color: #64748b; }
        .link-inputs-container { display: none; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; background: #fff7ed; padding: 15px; border-radius: 10px; border: 1px solid #ffedd5; }
        .link-input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace; direction: ltr; font-size: 12px; }

        #securityOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1e293b; z-index: 10000; display: flex; justify-content: center; align-items: center; }
        .auth-box { background: white; padding: 30px; border-radius: 20px; text-align: center; width: 90%; max-width: 350px; }
        .admin-btn { position: absolute; top: 20px; left: 20px; padding: 5px 10px; border-radius: 5px; border: none; cursor: pointer; font-family: inherit; font-size: 0.8em; background: #eee; }

        /* Filter Header */
        .filter-header { display: none; margin-bottom: 20px; align-items: center; justify-content: space-between; background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .filter-info { display: flex; align-items: center; gap: 15px; }
        .filter-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }
        .filter-placeholder { width: 50px; height: 50px; border-radius: 50%; background: #e0e7ff; color: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: bold; }

        @media (max-width: 600px) {
            .a4-paper { width: 100%; padding: 10mm; min-height: auto; aspect-ratio: 210/297; }
            .editor-header { position: sticky; top: 0; }
            .paper-wrapper { padding: 10px 0; }
            .link-inputs-container { grid-template-columns: 1fr; }
            .buttons-row { flex-direction: column; }
        }
        
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:3000; display:none; flex-direction:column; justify-content:center; align-items:center; color:var(--primary); font-weight:bold;}
    </style>
</head>
<body>

    <div id="securityOverlay">
        <div class="auth-box">
            <h2>ğŸ”’ Ù¾Ø§Ø±ÛØ²Ø±Ø§Ùˆ</h2>
            <p style="color:#64748b; margin:10px 0;">ØªÚ©Ø§ÛŒÛ• ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ Ø¨Ù†ÙˆÙˆØ³Û•</p>
            <input type="password" id="sitePassword" style="width:100%; padding:10px; text-align:center; border:1px solid #ddd; border-radius:10px; margin-bottom:15px;" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢">
            <button onclick="checkPassword()" style="width:100%; padding:10px; background:var(--primary); color:white; border:none; border-radius:10px; font-weight:bold;">Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•</button>
            <p id="errorMsg" style="color:red; margin-top:10px; display:none;">Ù‡Û•ÚµÛ•ÛŒÛ•!</p>
        </div>
    </div>

    <div id="loader">
        <div style="font-size:20px; margin-bottom:10px">â³</div>
        <span id="loaderText">Ø¯Ø§ØªØ§ Ø¯Û•Ù†ÛØ±Ø¯Ø±ÛØª... ØªÚ©Ø§ÛŒÛ• Ú†Ø§ÙˆÛ•Ú•ÛØ¨Û•</span>
    </div>

    <div class="container" id="mainContent">
        <header>
            <button onclick="toggleAdmin()" class="admin-btn" id="adminBtn">ğŸ”‘ Ø¦Û•Ø¯Ù…ÛŒÙ†</button>
            <h1>ğŸ« Ù‚ÙˆØªØ§Ø¨Ø®Ø§Ù†Û•ÛŒ Ú¯Ø²Ù†Ú¯</h1>
            <p style="color:#64748b">Ø¦Û•Ø±Ø´ÛŒÙÛŒ Ú†Ø§Ù„Ø§Ú©ÛŒÛ•Ú©Ø§Ù†</p>
        </header>

        <div class="nav-tabs">
            <button onclick="switchView('archive')" class="tab-btn active" id="btn-archive">Ø¦Û•Ø±Ø´ÛŒÙ</button>
            <button onclick="switchView('teachers')" class="tab-btn" id="btn-teachers">Ù…Ø§Ù…Û†Ø³ØªØ§ÛŒØ§Ù†</button>
        </div>

        <!-- Ø¨Û•Ø´ÛŒ ÙÙ„ØªÛ•Ø±ÛŒ Ù…Ø§Ù…Û†Ø³ØªØ§ -->
        <div id="filterHeader" class="filter-header">
            <div class="filter-info">
                <div id="filterAvatarContainer"></div>
                <div>
                    <div style="font-size: 0.9em; color: #666;">Ø¦Û•Ø±Ø´ÛŒÙÛŒ Ù…Ø§Ù…Û†Ø³ØªØ§:</div>
                    <h2 id="filterName" style="margin: 0; font-size: 1.2em;">...</h2>
                </div>
            </div>
            <button onclick="clearFilter()" style="background: #fee2e2; color: #ef4444; border: none; padding: 8px 15px; border-radius: 8px; font-weight: bold; cursor: pointer;">âŒ Ú¯Û•Ú•Ø§Ù†Û•ÙˆÛ•</button>
        </div>

        <div class="controls" id="archiveControls">
            <input type="text" class="search-box" id="searchBox" placeholder="Ú¯Û•Ú•Ø§Ù†...">
            
            <div class="buttons-row">
                <button class="add-btn btn-upload" onclick="openEditor('file')">ğŸ“ Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù† (Upload)</button>
                <button class="add-btn btn-link" onclick="openEditor('link')">ğŸ”— Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù† (Link)</button>
            </div>
        </div>

        <div class="controls" id="teachersControls" style="display:none;">
            <div class="buttons-row" style="width:100%;">
                <button class="add-btn btn-upload" onclick="openAddTeacherModal()">â• Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†ÛŒ Ù…Ø§Ù…Û†Ø³ØªØ§ÛŒ Ù†ÙˆÛ</button>
            </div>
        </div>

        <div class="activities-grid" id="activitiesGrid"></div>
        <div class="teachers-grid" id="teachersGrid" style="display:none;"></div>
    </div>

    <!-- Teacher Modal -->
    <div class="simple-modal" id="teacherModal">
        <div class="simple-modal-content">
            <h3>Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†ÛŒ Ù…Ø§Ù…Û†Ø³ØªØ§</h3>
            <input type="text" id="newTeacherName" style="width:100%; padding:10px; margin:15px 0; border:1px solid #ddd; border-radius:8px;" placeholder="Ù†Ø§ÙˆÛŒ Ø³ÛŒØ§Ù†ÛŒ Ù…Ø§Ù…Û†Ø³ØªØ§...">
            <button onclick="saveNewTeacher()" class="tool-btn primary" style="width:100%;">Ø³Û•ÛŒÚ¤Ú©Ø±Ø¯Ù†</button>
            <button onclick="document.getElementById('teacherModal').classList.remove('active')" class="tool-btn danger" style="width:100%; margin-top:10px;">Ø¯Ø§Ø®Ø³ØªÙ†</button>
        </div>
    </div>

    <!-- Photo Upload Modal for Teacher -->
    <div class="simple-modal" id="photoModal">
        <div class="simple-modal-content">
            <h3>Ú¯Û†Ú•ÛŒÙ†ÛŒ ÙˆÛÙ†Û•ÛŒ Ù…Ø§Ù…Û†Ø³ØªØ§</h3>
            <p id="photoTeacherName" style="color:#666; margin-bottom:15px;">...</p>
            <input type="file" id="teacherPhotoInput" accept="image/*" style="display:none" onchange="handleTeacherPhotoSelect(this)">
            <button onclick="document.getElementById('teacherPhotoInput').click()" class="tool-btn" style="width:100%; margin-bottom:10px;">ğŸ“‚ Ù‡Û•ÚµØ¨Ú˜Ø§Ø±Ø¯Ù†ÛŒ ÙˆÛÙ†Û•</button>
            <button onclick="document.getElementById('photoModal').classList.remove('active')" class="tool-btn danger" style="width:100%;">Ø¯Ø§Ø®Ø³ØªÙ†</button>
        </div>
    </div>

    <!-- Report Editor -->
    <div class="editor-modal" id="editorModal">
        <div class="editor-header">
            <button onclick="closeEditor()" class="tool-btn danger">Ø¯Ø§Ø®Ø³ØªÙ†</button>
            <div class="editor-tools">
                <button onclick="toggleImageMode()" id="btnImgMode" class="tool-btn">Ú¯Û†Ú•ÛŒÙ†ÛŒ Ù…Û†Ø¯</button>
                <button onclick="toggleLayout()" class="tool-btn">ğŸ”„ Ú¯Û†Ú•ÛŒÙ†ÛŒ ÙˆÛÙ†Û•</button>
                <button onclick="printReport()" class="tool-btn">ğŸ–¨ï¸ Ù¾Ø±ÛŒÙ†Øª</button>
                <button onclick="downloadAsImage()" class="tool-btn">â¬‡ï¸ Ø¯Ø§Ø¨Û•Ø²Ø§Ù†Ø¯Ù†</button>
                <button onclick="saveToArchive()" class="tool-btn primary">ğŸ’¾ Ø³Û•ÛŒÚ¤Ú©Ø±Ø¯Ù†</button>
            </div>
        </div>

        <div class="paper-wrapper">
            <div class="a4-paper" id="reportPaper">
                <div class="rep-header">
                    <div><h1 style="font-size:22px; margin:0; color:black;">Ù‚ÙˆØªØ§Ø¨Ø®Ø§Ù†Û•ÛŒ Ú¯Ø²Ù†Ú¯</h1><p style="margin:5px 0 0 0; font-size:14px; color:#555;">ÙÛ†Ø±Ù…ÛŒ Ú•Ø§Ù¾Û†Ø±ØªÛŒ Ú†Ø§Ù„Ø§Ú©ÛŒ</p></div>
                    <div class="rep-logo">LOGO</div>
                </div>
                <div class="rep-form-grid">
                    <div class="form-item"><label>Ø¨Ø§Ø¨Û•Øª / Ú†Ø§Ù„Ø§Ú©ÛŒ</label><input type="text" class="form-input" id="inpName" placeholder="Ø¨Ù†ÙˆÙˆØ³Û•..."></div>
                    <div class="form-item"><label>Ù„ÛŒÚ˜Ù†Û•</label><input type="text" class="form-input" id="inpComm" placeholder="Ø¨Ù†ÙˆÙˆØ³Û•..."></div>
                    <div class="form-item"><label>Ù…Ø§Ù…Û†Ø³ØªØ§ / Ø³Û•Ø±Ù¾Û•Ø±Ø´ØªÛŒØ§Ø±</label><input type="text" class="form-input" id="inpTeacher" placeholder="Ø¨Ù†ÙˆÙˆØ³Û•..."></div>
                    <div class="form-item"><label>Ø¨Û•Ø±ÙˆØ§Ø±</label><input type="date" class="form-input" id="inpDate" style="text-align:right;"></div>
                </div>
                <div class="link-inputs-container" id="linkInputsArea">
                    <input type="text" class="link-input" placeholder="Ù„ÛŒÙ†Ú©ÛŒ ÙˆÛÙ†Û•ÛŒ Ù¡..." oninput="updateLinkPreview(0, this.value)">
                    <input type="text" class="link-input" placeholder="Ù„ÛŒÙ†Ú©ÛŒ ÙˆÛÙ†Û•ÛŒ Ù¢..." oninput="updateLinkPreview(1, this.value)">
                    <input type="text" class="link-input" placeholder="Ù„ÛŒÙ†Ú©ÛŒ ÙˆÛÙ†Û•ÛŒ Ù£..." oninput="updateLinkPreview(2, this.value)">
                    <input type="text" class="link-input" placeholder="Ù„ÛŒÙ†Ú©ÛŒ ÙˆÛÙ†Û•ÛŒ Ù¤..." oninput="updateLinkPreview(3, this.value)">
                </div>
                <div class="rep-images layout-landscape" id="imgContainer">
                    <div class="img-slot" onclick="triggerFile(0)" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)" ondrop="handleDrop(event, 0)"><img id="img0"><div class="placeholder-text">ÙˆÛÙ†Û•ÛŒ Ù¡<br>ğŸ“¸</div></div>
                    <div class="img-slot" onclick="triggerFile(1)" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)" ondrop="handleDrop(event, 1)"><img id="img1"><div class="placeholder-text">ÙˆÛÙ†Û•ÛŒ Ù¢<br>ğŸ“¸</div></div>
                    <div class="img-slot" onclick="triggerFile(2)" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)" ondrop="handleDrop(event, 2)"><img id="img2"><div class="placeholder-text">ÙˆÛÙ†Û•ÛŒ Ù£<br>ğŸ“¸</div></div>
                    <div class="img-slot" onclick="triggerFile(3)" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)" ondrop="handleDrop(event, 3)"><img id="img3"><div class="placeholder-text">ÙˆÛÙ†Û•ÛŒ Ù¤<br>ğŸ“¸</div></div>
                </div>
                <input type="file" id="hiddenFileInput" accept="image/*" style="display:none">
                <div class="rep-notes"><label style="font-size:0.9em; font-weight:bold;">ØªÛØ¨ÛŒÙ†ÛŒ Ùˆ ÙˆØ±Ø¯Û•Ú©Ø§Ø±ÛŒ:</label><textarea id="inpNotes" placeholder="Ù„ÛØ±Û• Ø¨Ù†ÙˆÙˆØ³Û•..."></textarea></div>
                <div class="rep-footer"><p class="school-name-footer">Ù‚ÙˆØªØ§Ø¨Ø®Ø§Ù†Û•ÛŒ Ú¯Ø²Ù†Ú¯ÛŒ Ø¦ÛŒÙ†Ú¯Ù„ÛŒØ²ÛŒ Ù†Ø§Ø­Ú©ÙˆÙ…ÛŒ</p></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy, setDoc, getDocs, where, deleteField, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        
        const IMGBB_API_KEY = "0792200cd18a10eadeeccf373d03e4f7"; 

        const firebaseConfig = {
            apiKey: "AIzaSyAr_JHCa5BbM5RJ9KCp0IBom1rdAgVX4CM",
            authDomain: "gzng-f4273.firebaseapp.com",
            projectId: "gzng-f4273",
            storageBucket: "gzng-f4273.firebasestorage.app",
            messagingSenderId: "417779309632",
            appId: "1:417779309632:web:6ed119d26baa35822cd3a5",
            measurementId: "G-B6V0CHGQV6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const activitiesRef = collection(db, "activities");
        const teachersRef = collection(db, "teachers");

        let allActivities = [];
        let allTeachers = [];
        window.isAdmin = false;
        window.localFiles = [null, null, null, null]; 
        window.linkUrls = ["", "", "", ""];
        window.currentSlot = 0;
        window.useLinks = false; 
        let currentFilter = null;
        let teacherPhotoTarget = null;

        // Load Activities
        const q = query(activitiesRef, orderBy("date", "desc"));
        onSnapshot(q, (snapshot) => {
            allActivities = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderApp();
        });

        // Load Teachers Metadata (Photos)
        onSnapshot(teachersRef, (snapshot) => {
            allTeachers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderApp();
        });

        function renderApp() {
            if(currentFilter) {
                renderFilteredView();
                return;
            }

            const grid = document.getElementById('activitiesGrid');
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            
            const displayList = allActivities.filter(a => 
                a.name.toLowerCase().includes(searchTerm) || 
                a.teacher.toLowerCase().includes(searchTerm)
            );

            grid.innerHTML = displayList.map(act => `
                <div class="activity-card">
                    <div class="card-header">
                        <h3>${act.name}</h3>
                        <div class="card-meta"><span>ğŸ‘¤ ${act.teacher}</span><span>ğŸ“… ${act.date}</span></div>
                    </div>
                    <div class="card-imgs">
                        ${act.images ? act.images.slice(0,4).map(url => `<img src="${url}">`).join('') : ''}
                    </div>
                    <div class="card-actions">
                        <button class="action-btn btn-view" onclick="viewSavedReport('${act.id}')">ğŸ“„ Ú•Ø§Ù¾Û†Ø±Øª</button>
                        ${window.isAdmin ? `<button class="action-btn btn-del" style="display:block" onclick="deleteItem('${act.id}')">ğŸ—‘ï¸ Ø³Ú•ÛŒÙ†Û•ÙˆÛ•</button>` : ''}
                    </div>
                </div>
            `).join('');
            
            renderTeachersList();
        }

        function renderTeachersList() {
            const tGrid = document.getElementById('teachersGrid');
            const tMap = {};
            
            // 1. Get teachers from activities
            allActivities.forEach(a => { 
                const t = a.teacher.trim(); 
                tMap[t] = (tMap[t] || 0) + 1; 
            });

            // 2. Get manual teachers (even with 0 activities)
            allTeachers.forEach(t => {
                if (!tMap[t.name]) tMap[t.name] = 0;
            });

            const sortedTeachers = Object.keys(tMap).sort((a, b) => tMap[b] - tMap[a]);

            tGrid.innerHTML = sortedTeachers.map(tName => {
                const meta = allTeachers.find(t => t.name === tName);
                const photoUrl = meta && meta.photo ? meta.photo : null;
                
                return `
                <div class="teacher-card" onclick="filterByTeacher('${tName}')">
                    <div class="teacher-img-wrapper">
                        ${photoUrl ? `<img src="${photoUrl}" class="teacher-img">` : `<div class="teacher-placeholder">ğŸ‘¤</div>`}
                    </div>
                    <div class="teacher-name">${tName}</div>
                    <div class="teacher-stats">ğŸ“Š ${tMap[tName]} Ú†Ø§Ù„Ø§Ú©ÛŒ</div>
                    
                    ${window.isAdmin ? `
                    <div class="teacher-admin-controls" onclick="event.stopPropagation()">
                        <button class="btn-icon btn-edit-photo" title="Ú¯Û†Ú•ÛŒÙ†ÛŒ ÙˆÛÙ†Û•" onclick="openPhotoModal('${tName}')">ğŸ“·</button>
                        <button class="btn-icon btn-delete-teacher" title="Ø³Ú•ÛŒÙ†Û•ÙˆÛ•ÛŒ Ù¾Ø±Û†ÙØ§ÛŒÙ„" onclick="deleteTeacherProfile('${tName}')">ğŸ—‘ï¸</button>
                    </div>` : ''}
                </div>
            `}).join('');
            
            // Show Admin controls on cards if Admin
            const adminControls = document.querySelectorAll('.teacher-admin-controls');
            adminControls.forEach(el => el.style.display = window.isAdmin ? 'flex' : 'none');
        }

        window.filterByTeacher = (tName) => {
            currentFilter = tName;
            switchView('archive'); // Go to archive tab but filtered
        };

        function renderFilteredView() {
            const grid = document.getElementById('activitiesGrid');
            document.getElementById('archiveControls').style.display = 'none';
            document.getElementById('filterHeader').style.display = 'flex';
            document.getElementById('filterName').innerText = currentFilter;
            
            // Show Avatar in header
            const meta = allTeachers.find(t => t.name === currentFilter);
            const photoUrl = meta && meta.photo ? meta.photo : null;
            document.getElementById('filterAvatarContainer').innerHTML = photoUrl ? 
                `<img src="${photoUrl}" class="filter-avatar">` : 
                `<div class="filter-placeholder">ğŸ‘¤</div>`;

            const filteredList = allActivities.filter(a => a.teacher === currentFilter);
            
            grid.innerHTML = filteredList.map(act => `
                <div class="activity-card">
                    <div class="card-header">
                        <h3>${act.name}</h3>
                        <div class="card-meta"><span>ğŸ“… ${act.date}</span></div>
                    </div>
                    <div class="card-imgs">
                        ${act.images ? act.images.slice(0,4).map(url => `<img src="${url}">`).join('') : ''}
                    </div>
                    <div class="card-actions">
                        <button class="action-btn btn-view" onclick="viewSavedReport('${act.id}')">ğŸ“„ Ú•Ø§Ù¾Û†Ø±Øª</button>
                        ${window.isAdmin ? `<button class="action-btn btn-del" style="display:block" onclick="deleteItem('${act.id}')">ğŸ—‘ï¸ Ø³Ú•ÛŒÙ†Û•ÙˆÛ•</button>` : ''}
                    </div>
                </div>
            `).join('');
            
            if(filteredList.length === 0) grid.innerHTML = '<p style="text-align:center; grid-column:1/-1; margin-top:50px;">Ù‡ÛŒÚ† Ú†Ø§Ù„Ø§Ú©ÛŒÛŒÛ•Ú© Ù†ÛŒÛŒÛ•.</p>';
        }

        window.clearFilter = () => {
            currentFilter = null;
            document.getElementById('filterHeader').style.display = 'none';
            document.getElementById('archiveControls').style.display = 'flex'; // Show controls again
            renderApp();
        };

        // --- Admin Teacher Functions ---
        window.openAddTeacherModal = () => {
            document.getElementById('newTeacherName').value = '';
            document.getElementById('teacherModal').classList.add('active');
        };

        window.saveNewTeacher = async () => {
            const name = document.getElementById('newTeacherName').value.trim();
            if(!name) return;
            
            // Check if exists
            const exists = allTeachers.find(t => t.name === name);
            if(exists) { alert("Ø¦Û•Ù… Ù…Ø§Ù…Û†Ø³ØªØ§ÛŒÛ• Ù‡Û•ÛŒÛ•!"); return; }

            await addDoc(teachersRef, { name: name, photo: "" });
            document.getElementById('teacherModal').classList.remove('active');
            alert("Ù…Ø§Ù…Û†Ø³ØªØ§ Ø²ÛŒØ§Ø¯ Ú©Ø±Ø§.");
        };

        window.deleteTeacherProfile = async (tName) => {
            if(!confirm(`Ø¯ÚµÙ†ÛŒØ§ÛŒØª Ù„Û• Ø³Ú•ÛŒÙ†Û•ÙˆÛ•ÛŒ Ù¾Ø±Û†ÙØ§ÛŒÙ„ÛŒ "${tName}"ØŸ \nØªÛØ¨ÛŒÙ†ÛŒ: Ø¦Û•Ù…Û• Ú†Ø§Ù„Ø§Ú©ÛŒÛŒÛ•Ú©Ø§Ù†ÛŒ Ù†Ø§Ø³Ú•ÛØªÛ•ÙˆÛ•ØŒ ØªÛ•Ù†Ù‡Ø§ Ù¾Ø±Û†ÙØ§ÛŒÙ„Û•Ú©Û•ÛŒ.`)) return;
            
            // Delete from 'teachers' collection
            const meta = allTeachers.find(t => t.name === tName);
            if(meta) {
                await deleteDoc(doc(db, "teachers", meta.id));
            }
            alert("Ù¾Ø±Û†ÙØ§ÛŒÙ„ Ø³Ú•Ø§ÛŒÛ•ÙˆÛ•.");
        };

        // --- Photo Upload ---
        window.openPhotoModal = (tName) => {
            teacherPhotoTarget = tName;
            document.getElementById('photoTeacherName').innerText = tName;
            document.getElementById('photoModal').classList.add('active');
        };

        window.handleTeacherPhotoSelect = async (input) => {
            const file = input.files[0];
            if(!file) return;
            
            document.getElementById('loader').style.display = 'flex';
            document.getElementById('loaderText').innerText = "ÙˆÛÙ†Û• Ø¦Ø§Ù¾Ù„Û†Ø¯ Ø¯Û•Ú©Ø±ÛØª...";
            document.getElementById('photoModal').classList.remove('active');

            try {
                const url = await uploadToImgBB(file);
                
                // Save url to 'teachers' collection
                const meta = allTeachers.find(t => t.name === teacherPhotoTarget);
                if(meta) {
                    // Update existing
                    await updateDoc(doc(db, "teachers", meta.id), { photo: url });
                } else {
                    // Create new entry if not exists
                    await addDoc(teachersRef, { name: teacherPhotoTarget, photo: url });
                }
                alert("ÙˆÛÙ†Û•Ú©Û• Ú¯Û†Ú•Ø¯Ø±Ø§!");
            } catch(e) {
                alert("Ú©ÛØ´Û•: " + e.message);
            } finally {
                document.getElementById('loader').style.display = 'none';
                input.value = '';
            }
        };

        // --- Standard Functions ---
        window.openEditor = (mode) => {
            document.getElementById('inpName').value = '';
            document.getElementById('inpComm').value = '';
            document.getElementById('inpTeacher').value = '';
            document.getElementById('inpDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('inpNotes').value = '';
            window.localFiles = [null, null, null, null];
            window.linkUrls = ["", "", "", ""];
            if (mode === 'link') window.useLinks = true; else window.useLinks = false;
            updateImageModeUI();
            for(let i=0; i<4; i++) {
                document.getElementById('img'+i).src = '';
                document.getElementById('img'+i).parentElement.classList.remove('has-img');
                document.querySelectorAll('.link-input')[i].value = '';
            }
            document.getElementById('editorModal').classList.add('active');
        };

        window.closeEditor = () => document.getElementById('editorModal').classList.remove('active');
        window.toggleImageMode = () => { window.useLinks = !window.useLinks; updateImageModeUI(); };

        function updateImageModeUI() {
            const btn = document.getElementById('btnImgMode');
            const inputs = document.getElementById('linkInputsArea');
            if (window.useLinks) {
                btn.classList.add('active-mode');
                btn.innerText = "ğŸ“‚ Ú¯Û†Ú•ÛŒÙ† Ø¨Û† ÙØ§ÛŒÙ„ (Upload)";
                inputs.style.display = 'grid';
            } else {
                btn.classList.remove('active-mode');
                btn.innerText = "ğŸ”— Ú¯Û†Ú•ÛŒÙ† Ø¨Û† Ù„ÛŒÙ†Ú© (ImgBB)";
                inputs.style.display = 'none';
            }
        }

        window.updateLinkPreview = (index, url) => {
            window.linkUrls[index] = url;
            const imgEl = document.getElementById('img' + index);
            if (url) { imgEl.src = url; imgEl.parentElement.classList.add('has-img'); } 
            else { imgEl.src = ''; imgEl.parentElement.classList.remove('has-img'); }
        };

        window.toggleLayout = () => {
            const c = document.getElementById('imgContainer');
            if(c.classList.contains('layout-landscape')) { c.classList.remove('layout-landscape'); c.classList.add('layout-portrait'); } 
            else { c.classList.remove('layout-portrait'); c.classList.add('layout-landscape'); }
        };

        window.triggerFile = (index) => { if (window.useLinks) return; window.currentSlot = index; document.getElementById('hiddenFileInput').click(); };
        window.allowDrop = (e) => { if (window.useLinks) return; e.preventDefault(); e.currentTarget.classList.add('drag-over'); };
        window.leaveDrop = (e) => { e.currentTarget.classList.remove('drag-over'); }
        window.handleDrop = (e, index) => { if (window.useLinks) return; e.preventDefault(); e.currentTarget.classList.remove('drag-over'); const file = e.dataTransfer.files[0]; if(file && file.type.startsWith('image/')) processFile(file, index); };

        function processFile(file, index) {
            window.localFiles[index] = file;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const imgEl = document.getElementById('img' + index);
                imgEl.src = ev.target.result;
                imgEl.parentElement.classList.add('has-img');
            };
            reader.readAsDataURL(file);
        }

        document.getElementById('hiddenFileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(file) processFile(file, window.currentSlot);
            e.target.value = '';
        });

        window.printReport = () => window.print();
        window.downloadAsImage = () => {
            const el = document.querySelector(".a4-paper");
            html2canvas(el, { scale: 2, useCORS: true }).then(canvas => {
                const a = document.createElement('a'); a.download = 'Gzng_Report.jpg'; a.href = canvas.toDataURL('image/jpeg', 0.9); a.click();
            }).catch(e => alert("Ù‡Û•ÚµÛ•: " + e));
        };

        async function uploadToImgBB(file) {
            const formData = new FormData(); formData.append("image", file);
            const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, { method: "POST", body: formData });
            const result = await response.json();
            if (result.success) return result.data.url; else throw new Error("ImgBB Upload Failed");
        }

        window.saveToArchive = async () => {
            const name = document.getElementById('inpName').value;
            const teacher = document.getElementById('inpTeacher').value;
            if(!name || !teacher) { alert("ØªÚ©Ø§ÛŒÛ• Ù†Ø§Ùˆ Ùˆ Ù…Ø§Ù…Û†Ø³ØªØ§ Ø¨Ù†ÙˆÙˆØ³Û•!"); return; }

            const loader = document.getElementById('loader');
            const loaderText = document.getElementById('loaderText');
            loader.style.display = 'flex';

            try {
                let imageUrls = [];
                if (window.useLinks) { imageUrls = window.linkUrls.filter(url => url.trim() !== ""); } 
                else {
                    for(let i=0; i<4; i++) {
                        const file = window.localFiles[i];
                        if(file) {
                            loaderText.innerText = `ÙˆÛÙ†Û•ÛŒ ${i+1} Ø¦Ø§Ù¾Ù„Û†Ø¯ Ø¯Û•Ú©Ø±ÛØª...`;
                            const url = await uploadToImgBB(file);
                            imageUrls.push(url);
                        }
                    }
                }
                loaderText.innerText = "ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø¯Ù†...";
                await addDoc(activitiesRef, { name: name, committee: document.getElementById('inpComm').value, teacher: teacher, date: document.getElementById('inpDate').value, notes: document.getElementById('inpNotes').value, images: imageUrls, createdAt: new Date() });
                loader.style.display = 'none'; alert("âœ… Ø³Û•ÛŒÚ¤ Ú©Ø±Ø§!"); closeEditor();
            } catch(err) { loader.style.display = 'none'; alert("Ù‡Û•ÚµÛ•: " + err.message); }
        };

        window.viewSavedReport = (id) => {
            const act = allActivities.find(a => a.id === id);
            if(!act) return;
            openEditor(); 
            document.getElementById('inpName').value = act.name;
            document.getElementById('inpComm').value = act.committee || '';
            document.getElementById('inpTeacher').value = act.teacher;
            document.getElementById('inpDate').value = act.date;
            document.getElementById('inpNotes').value = act.notes || '';
            for(let i=0; i<4; i++) {
                const imgEl = document.getElementById('img'+i);
                if(act.images && act.images[i]) { imgEl.src = act.images[i]; imgEl.parentElement.classList.add('has-img'); }
            }
            document.querySelector('.tool-btn.primary').style.display = 'none';
        };

        window.switchView = (v) => {
            document.getElementById('activitiesGrid').style.display = v==='archive'?'grid':'none';
            document.getElementById('archiveControls').style.display = v==='archive'?'flex':'none';
            document.getElementById('teachersGrid').style.display = v==='teachers'?'grid':'none';
            document.getElementById('teachersControls').style.display = v==='teachers' && window.isAdmin ? 'flex' : 'none';
            document.getElementById('btn-archive').classList.toggle('active', v==='archive');
            document.getElementById('btn-teachers').classList.toggle('active', v==='teachers');
            if(v==='teachers') renderTeachersList(); // Force refresh
        };
        window.deleteItem = async (id) => { if(confirm("Ø¯ÚµÙ†ÛŒØ§ÛŒØªØŸ")) await deleteDoc(doc(db, "activities", id)); };
        document.getElementById('searchBox').addEventListener('input', renderApp);
    </script>

    <script>
        function checkPassword() {
            if(document.getElementById('sitePassword').value === "2526") { 
                document.getElementById('securityOverlay').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
            } else { document.getElementById('errorMsg').style.display = 'block'; }
        }
        function toggleAdmin() {
            if(window.isAdmin) {
                window.isAdmin = false; document.getElementById('adminBtn').style.background="#eee";
                window.renderApp();
                document.getElementById('teachersControls').style.display = 'none';
                alert("Ø¯Û•Ø±Ú†ÙˆÙˆÛŒØª.");
            } else {
                if(prompt("Ù¾Ø§Ø³Û†Ø±Ø¯ÛŒ Ø¦Û•Ø¯Ù…ÛŒÙ†:") === "2324") {
                    window.isAdmin = true; document.getElementById('adminBtn').style.background="#86efac";
                    window.renderApp();
                    // Show add button if on teachers tab
                    const isTeachersTab = document.getElementById('btn-teachers').classList.contains('active');
                    if(isTeachersTab) document.getElementById('teachersControls').style.display = 'flex';
                    alert("Ø¨Û•Ø®ÛØ±Ø¨ÛÛŒØª Ø¦Û•Ø¯Ù…ÛŒÙ†.");
                } else alert("Ù‡Û•ÚµÛ•ÛŒÛ•!");
            }
        }
    </script>
</body>
</html><!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø³ÛŒØ³ØªÛ•Ù…ÛŒ Ú•Ø§Ù¾Û†Ø±Øª Ùˆ Ø¦Û•Ø±Ø´ÛŒÙÛŒ Ú¯Ø²Ù†Ú¯</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #4f46e5; --bg-color: #f3f4f6; --card-bg: #ffffff;
            --text-dark: #1e293b; --text-gray: #64748b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Noto Sans Arabic', sans-serif; background-color: var(--bg-color); min-height: 100vh; padding: 10px; color: var(--text-dark); }
        
        .container { max-width: 1200px; margin: 0 auto; padding-bottom: 80px; display: none; }
        header { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; margin-bottom: 20px; position: relative; }
        h1 { font-size: 1.5em; margin-bottom: 5px; font-weight: 900; color: var(--primary); }
        
        .nav-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .tab-btn { background: white; border: 1px solid #ddd; padding: 8px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; font-family: inherit; transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        .controls { background: white; padding: 15px; border-radius: 16px; margin-bottom: 20px; display: flex; flex-direction: column; gap: 10px; }
        .search-box { padding: 12px; border-radius: 10px; border: 1px solid #ddd; font-family: inherit; width: 100%; }
        
        .add-btn { 
            width: 100%; border: none; padding: 15px; border-radius: 10px; 
            font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; 
            color: white; font-family: 'Noto Sans Arabic'; font-size: 1.1em;
            background: linear-gradient(135deg, var(--primary), #4338ca);
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
        }

        .activities-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .activity-card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: 0.3s; }
        .activity-card:hover { transform: translateY(-5px); }
        .card-header { padding: 15px; border-bottom: 1px solid #eee; }
        .card-header h3 { font-size: 1.1em; margin-bottom: 5px; }
        .card-meta { font-size: 0.85em; color: var(--text-gray); display: flex; justify-content: space-between; }
        .card-imgs { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1px; height: 180px; overflow: hidden; background: #eee; }
        .card-imgs img { width: 100%; height: 100%; object-fit: cover; }
        .card-actions { padding: 10px; display: flex; gap: 10px; background: #fafafa; }
        .action-btn { flex: 1; padding: 8px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-family: inherit; font-size: 0.9em; }
        .btn-view { background: #e0e7ff; color: var(--primary); }
        .btn-del { background: #fee2e2; color: #ef4444; display: none; }

        .editor-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8fafc; z-index: 2000; overflow-y: auto; }
        .editor-modal.active { display: block; }
        
        .editor-header { background: white; padding: 15px; position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .editor-tools { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .tool-btn { padding: 8px 15px; border-radius: 8px; border: 1px solid #ddd; background: white; cursor: pointer; font-family: inherit; font-weight: bold; font-size: 0.9em; white-space: nowrap; }
        .tool-btn.primary { background: var(--primary); color: white; border-color: var(--primary); }
        .tool-btn.danger { background: white; color: #ef4444; border-color: #ef4444; }

        .paper-wrapper { padding: 20px; display: flex; justify-content: center; }
        .a4-paper { 
            width: 210mm; min-height: 297mm; background: white; padding: 15mm; 
            box-shadow: 0 0 20px rgba(0,0,0,0.1); position: relative; 
            color: black; direction: rtl; text-align: right; 
            display: flex; flex-direction: column;
        }
        
        @media print {
            body * { visibility: hidden; }
            .editor-modal, .editor-modal * { visibility: visible; }
            .editor-header, .editor-tools { display: none !important; }
            .paper-wrapper { padding: 0; margin: 0; }
            .a4-paper { box-shadow: none; width: 100%; height: 100%; margin: 0; padding: 15mm; page-break-after: always; }
            .img-placeholder span { display: none; }
        }

        .rep-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #333; padding-bottom: 15px; margin-bottom: 20px; }
        .rep-logo { width: 70px; height: 70px; background: #f3f4f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid #ddd; }
        
        .rep-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; background: #f8fafc; padding: 15px; border-radius: 10px; border: 1px solid #e2e8f0; }
        .form-item label { display: block; font-size: 0.8em; color: #64748b; margin-bottom: 3px; }
        .form-input { width: 100%; border: none; background: transparent; font-family: inherit; font-weight: bold; font-size: 1em; border-bottom: 1px dashed #cbd5e1; padding: 2px; }
        .form-input:focus { outline: none; border-bottom-color: var(--primary); }

        .rep-images { display: grid; gap: 10px; margin-bottom: 20px; }
        .layout-landscape { grid-template-columns: 1fr 1fr; }
        .layout-landscape .img-slot { aspect-ratio: 16/9; }
        .layout-portrait { grid-template-columns: 1fr 1fr; }
        .layout-portrait .img-slot { aspect-ratio: 3/4; }

        .img-slot { 
            background: #f1f5f9; border: 2px dashed #cbd5e1; border-radius: 10px; 
            overflow: hidden; position: relative; cursor: pointer; display: flex; 
            align-items: center; justify-content: center; transition: 0.2s;
        }
        .img-slot:hover, .img-slot.drag-over { background: #e2e8f0; border-color: var(--primary); }
        .img-slot img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .img-slot.has-img img { display: block; }
        .img-slot.has-img .placeholder-text { display: none; }
        .placeholder-text { color: #94a3b8; font-size: 0.9em; text-align: center; pointer-events: none; }

        .rep-notes { margin-top: 10px; flex-grow: 1; }
        .rep-notes textarea { width: 100%; border: 1px solid #e2e8f0; border-radius: 10px; padding: 10px; font-family: inherit; resize: none; min-height: 200px; background: #fffbeb; font-size: 16px; line-height: 1.6; }

        .rep-footer { margin-top: auto; padding-top: 20px; text-align: center; border-top: 1px solid #eee; }
        .school-name-footer { font-size: 14px; font-weight: bold; color: #64748b; }

        #securityOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1e293b; z-index: 10000; display: flex; justify-content: center; align-items: center; }
        .auth-box { background: white; padding: 30px; border-radius: 20px; text-align: center; width: 90%; max-width: 350px; }
        .admin-btn { position: absolute; top: 20px; left: 20px; padding: 5px 10px; border-radius: 5px; border: none; cursor: pointer; font-family: inherit; font-size: 0.8em; background: #eee; }

        @media (max-width: 600px) {
            .a4-paper { width: 100%; padding: 10mm; min-height: auto; aspect-ratio: 210/297; }
            .editor-header { position: sticky; top: 0; }
            .paper-wrapper { padding: 10px 0; }
        }
        
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:3000; display:none; flex-direction:column; justify-content:center; align-items:center; color:var(--primary); font-weight:bold;}
    </style>
</head>
<body>

    <div id="securityOverlay">
        <div class="auth-box">
            <h2>ğŸ”’ Ù¾Ø§Ø±ÛØ²Ø±Ø§Ùˆ</h2>
            <p style="color:#64748b; margin:10px 0;">ØªÚ©Ø§ÛŒÛ• ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ Ø¨Ù†ÙˆÙˆØ³Û•</p>
            <input type="password" id="sitePassword" style="width:100%; padding:10px; text-align:center; border:1px solid #ddd; border-radius:10px; margin-bottom:15px;" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢">
            <button onclick="checkPassword()" style="width:100%; padding:10px; background:var(--primary); color:white; border:none; border-radius:10px; font-weight:bold;">Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•</button>
            <p id="errorMsg" style="color:red; margin-top:10px; display:none;">Ù‡Û•ÚµÛ•ÛŒÛ•!</p>
        </div>
    </div>

    <div id="loader">
        <div style="font-size:20px; margin-bottom:10px">â³</div>
        <span id="loaderText">Ø¯Ø§ØªØ§ Ø¯Û•Ù†ÛØ±Ø¯Ø±ÛØª... ØªÚ©Ø§ÛŒÛ• Ú†Ø§ÙˆÛ•Ú•ÛØ¨Û•</span>
    </div>

    <div class="container" id="mainContent">
        <header>
            <button onclick="toggleAdmin()" class="admin-btn" id="adminBtn">ğŸ”‘ Ø¦Û•Ø¯Ù…ÛŒÙ†</button>
            <h1>ğŸ« Ù‚ÙˆØªØ§Ø¨Ø®Ø§Ù†Û•ÛŒ Ú¯Ø²Ù†Ú¯</h1>
            <p style="color:#64748b">Ø¦Û•Ø±Ø´ÛŒÙÛŒ Ú†Ø§Ù„Ø§Ú©ÛŒÛ•Ú©Ø§Ù†</p>
        </header>

        <div class="nav-tabs">
            <button onclick="switchView('archive')" class="tab-btn active" id="btn-archive">Ø¦Û•Ø±Ø´ÛŒÙ</button>
            <button onclick="switchView('teachers')" class="tab-btn" id="btn-teachers">Ù…Ø§Ù…Û†Ø³ØªØ§ÛŒØ§Ù†</button>
        </div>

        <div class="controls" id="archiveControls">
            <input type="text" class="search-box" id="searchBox" placeholder="Ú¯Û•Ú•Ø§Ù†...">
            <button class="add-btn" onclick="openEditor()">ğŸ“ Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù†ÛŒ Ú†Ø§Ù„Ø§Ú©ÛŒ Ù†ÙˆÛ</button>
        </div>

        <div class="activities-grid" id="activitiesGrid"></div>
        <div class="activities-grid" id="teachersGrid" style="display:none;"></div>
    </div>

    <!-- Report Editor -->
    <div class="editor-modal" id="editorModal">
        <div class="editor-header">
            <button onclick="closeEditor()" class="tool-btn danger">Ø¯Ø§Ø®Ø³ØªÙ†</button>
            <div class="editor-tools">
                <button onclick="toggleLayout()" class="tool-btn">ğŸ”„ Ú¯Û†Ú•ÛŒÙ†ÛŒ ÙˆÛÙ†Û•</button>
                <button onclick="printReport()" class="tool-btn">ğŸ–¨ï¸ Ù¾Ø±ÛŒÙ†Øª</button>
                <button onclick="downloadAsImage()" class="tool-btn">â¬‡ï¸ Ø¯Ø§Ø¨Û•Ø²Ø§Ù†Ø¯Ù†</button>
                <button onclick="saveToArchive()" class="tool-btn primary">ğŸ’¾ Ø³Û•ÛŒÚ¤Ú©Ø±Ø¯Ù†</button>
            </div>
        </div>

        <div class="paper-wrapper">
            <div class="a4-paper" id="reportPaper">
                
                <div class="rep-header">
                    <div>
                        <h1 style="font-size:22px; margin:0; color:black;">Ù‚ÙˆØªØ§Ø¨Ø®Ø§Ù†Û•ÛŒ Ú¯Ø²Ù†Ú¯</h1>
                        <p style="margin:5px 0 0 0; font-size:14px; color:#555;">ÙÛ†Ø±Ù…ÛŒ Ú•Ø§Ù¾Û†Ø±ØªÛŒ Ú†Ø§Ù„Ø§Ú©ÛŒ</p>
                    </div>
                    <div class="rep-logo">LOGO</div>
                </div>

                <div class="rep-form-grid">
                    <div class="form-item">
                        <label>Ø¨Ø§Ø¨Û•Øª / Ú†Ø§Ù„Ø§Ú©ÛŒ</label>
                        <input type="text" class="form-input" id="inpName" placeholder="Ø¨Ù†ÙˆÙˆØ³Û•...">
                    </div>
                    <div class="form-item">
                        <label>Ù„ÛŒÚ˜Ù†Û•</label>
                        <input type="text" class="form-input" id="inpComm" placeholder="Ø¨Ù†ÙˆÙˆØ³Û•...">
                    </div>
                    <div class="form-item">
                        <label>Ù…Ø§Ù…Û†Ø³ØªØ§ / Ø³Û•Ø±Ù¾Û•Ø±Ø´ØªÛŒØ§Ø±</label>
                        <input type="text" class="form-input" id="inpTeacher" placeholder="Ø¨Ù†ÙˆÙˆØ³Û•...">
                    </div>
                    <div class="form-item">
                        <label>Ø¨Û•Ø±ÙˆØ§Ø±</label>
                        <input type="date" class="form-input" id="inpDate" style="text-align:right;">
                    </div>
                </div>

                <!-- ÙˆÛÙ†Û•Ú©Ø§Ù† -->
                <div class="rep-images layout-landscape" id="imgContainer">
                    <div class="img-slot" onclick="triggerFile(0)" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)" ondrop="handleDrop(event, 0)">
                        <img id="img0">
                        <div class="placeholder-text">ÙˆÛÙ†Û•ÛŒ Ù¡<br>ğŸ“¸</div>
                    </div>
                    <div class="img-slot" onclick="triggerFile(1)" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)" ondrop="handleDrop(event, 1)">
                        <img id="img1">
                        <div class="placeholder-text">ÙˆÛÙ†Û•ÛŒ Ù¢<br>ğŸ“¸</div>
                    </div>
                    <div class="img-slot" onclick="triggerFile(2)" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)" ondrop="handleDrop(event, 2)">
                        <img id="img2">
                        <div class="placeholder-text">ÙˆÛÙ†Û•ÛŒ Ù£<br>ğŸ“¸</div>
                    </div>
                    <div class="img-slot" onclick="triggerFile(3)" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)" ondrop="handleDrop(event, 3)">
                        <img id="img3">
                        <div class="placeholder-text">ÙˆÛÙ†Û•ÛŒ Ù¤<br>ğŸ“¸</div>
                    </div>
                </div>
                <input type="file" id="hiddenFileInput" accept="image/*" style="display:none">

                <div class="rep-notes">
                    <label style="font-size:0.9em; font-weight:bold;">ØªÛØ¨ÛŒÙ†ÛŒ Ùˆ ÙˆØ±Ø¯Û•Ú©Ø§Ø±ÛŒ:</label>
                    <textarea id="inpNotes" placeholder="Ù„ÛØ±Û• Ø¨Ù†ÙˆÙˆØ³Û•..."></textarea>
                </div>

                <div class="rep-footer">
                    <p class="school-name-footer">Ù‚ÙˆØªØ§Ø¨Ø®Ø§Ù†Û•ÛŒ Ú¯Ø²Ù†Ú¯ÛŒ Ø¦ÛŒÙ†Ú¯Ù„ÛŒØ²ÛŒ Ù†Ø§Ø­Ú©ÙˆÙ…ÛŒ</p>
                </div>

            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        
        const IMGBB_API_KEY = "0792200cd18a10eadeeccf373d03e4f7"; 

        const firebaseConfig = {
            apiKey: "AIzaSyAr_JHCa5BbM5RJ9KCp0IBom1rdAgVX4CM",
            authDomain: "gzng-f4273.firebaseapp.com",
            projectId: "gzng-f4273",
            storageBucket: "gzng-f4273.firebasestorage.app",
            messagingSenderId: "417779309632",
            appId: "1:417779309632:web:6ed119d26baa35822cd3a5",
            measurementId: "G-B6V0CHGQV6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const activitiesRef = collection(db, "activities");

        let allActivities = [];
        window.isAdmin = false;
        window.localFiles = [null, null, null, null]; 
        window.currentSlot = 0;

        const q = query(activitiesRef, orderBy("date", "desc"));
        onSnapshot(q, (snapshot) => {
            allActivities = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderApp();
        });

        function renderApp() {
            const grid = document.getElementById('activitiesGrid');
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            
            const displayList = allActivities.filter(a => 
                a.name.toLowerCase().includes(searchTerm) || 
                a.teacher.toLowerCase().includes(searchTerm)
            );

            grid.innerHTML = displayList.map(act => `
                <div class="activity-card">
                    <div class="card-header">
                        <h3>${act.name}</h3>
                        <div class="card-meta"><span>ğŸ‘¤ ${act.teacher}</span><span>ğŸ“… ${act.date}</span></div>
                    </div>
                    <div class="card-imgs">
                        ${act.images ? act.images.slice(0,4).map(url => `<img src="${url}">`).join('') : ''}
                    </div>
                    <div class="card-actions">
                        <button class="action-btn btn-view" onclick="viewSavedReport('${act.id}')">ğŸ“„ Ú•Ø§Ù¾Û†Ø±Øª</button>
                        ${window.isAdmin ? `<button class="action-btn btn-del" style="display:block" onclick="deleteItem('${act.id}')">ğŸ—‘ï¸ Ø³Ú•ÛŒÙ†Û•ÙˆÛ•</button>` : ''}
                    </div>
                </div>
            `).join('');
            
            const tGrid = document.getElementById('teachersGrid');
            const tMap = {};
            allActivities.forEach(a => { const t = a.teacher.trim(); tMap[t] = (tMap[t] || 0) + 1; });
            tGrid.innerHTML = Object.keys(tMap).map(t => `
                <div class="activity-card" style="padding:20px; text-align:center;">
                    <div style="font-size:40px; margin-bottom:10px">ğŸ‘¤</div>
                    <h3>${t}</h3>
                    <p style="color:#666">${tMap[t]} Ú†Ø§Ù„Ø§Ú©ÛŒ</p>
                </div>
            `).join('');
        }

        window.openEditor = () => {
            document.getElementById('inpName').value = '';
            document.getElementById('inpComm').value = '';
            document.getElementById('inpTeacher').value = '';
            document.getElementById('inpDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('inpNotes').value = '';
            
            // Reset images
            window.localFiles = [null, null, null, null];
            for(let i=0; i<4; i++) {
                document.getElementById('img'+i).src = '';
                document.getElementById('img'+i).parentElement.classList.remove('has-img');
            }
            document.getElementById('editorModal').classList.add('active');
        };

        window.closeEditor = () => document.getElementById('editorModal').classList.remove('active');

        window.toggleLayout = () => {
            const c = document.getElementById('imgContainer');
            if(c.classList.contains('layout-landscape')) {
                c.classList.remove('layout-landscape');
                c.classList.add('layout-portrait');
            } else {
                c.classList.remove('layout-portrait');
                c.classList.add('layout-landscape');
            }
        };

        window.triggerFile = (index) => {
            window.currentSlot = index;
            document.getElementById('hiddenFileInput').click();
        };

        window.allowDrop = (e) => {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        };

        window.leaveDrop = (e) => {
            e.currentTarget.classList.remove('drag-over');
        }

        window.handleDrop = (e, index) => {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if(file && file.type.startsWith('image/')) {
                processFile(file, index);
            }
        };

        function processFile(file, index) {
            window.localFiles[index] = file;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const imgEl = document.getElementById('img' + index);
                imgEl.src = ev.target.result;
                imgEl.parentElement.classList.add('has-img');
            };
            reader.readAsDataURL(file);
        }

        document.getElementById('hiddenFileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(file) processFile(file, window.currentSlot);
            e.target.value = '';
        });

        window.printReport = () => window.print();
        
        window.downloadAsImage = () => {
            const el = document.querySelector(".a4-paper");
            html2canvas(el, { scale: 2, useCORS: true }).then(canvas => {
                const a = document.createElement('a');
                a.download = 'Gzng_Report.jpg';
                a.href = canvas.toDataURL('image/jpeg', 0.9);
                a.click();
            }).catch(e => alert("Ù‡Û•ÚµÛ•: " + e));
        };

        // --- ImgBB Auto Upload Function ---
        async function uploadToImgBB(file) {
            const formData = new FormData();
            formData.append("image", file);
            
            const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                method: "POST",
                body: formData
            });
            
            const result = await response.json();
            if (result.success) {
                return result.data.url;
            } else {
                throw new Error("ImgBB Upload Failed");
            }
        }

        window.saveToArchive = async () => {
            const name = document.getElementById('inpName').value;
            const teacher = document.getElementById('inpTeacher').value;
            if(!name || !teacher) { alert("ØªÚ©Ø§ÛŒÛ• Ù†Ø§Ùˆ Ùˆ Ù…Ø§Ù…Û†Ø³ØªØ§ Ø¨Ù†ÙˆÙˆØ³Û•!"); return; }

            const loader = document.getElementById('loader');
            const loaderText = document.getElementById('loaderText');
            loader.style.display = 'flex';

            try {
                let imageUrls = [];
                
                // Auto Upload to ImgBB
                for(let i=0; i<4; i++) {
                    const file = window.localFiles[i];
                    if(file) {
                        loaderText.innerText = `ÙˆÛÙ†Û•ÛŒ ${i+1} Ø¦Ø§Ù¾Ù„Û†Ø¯ Ø¯Û•Ú©Ø±ÛØª Ø¨Û† ImgBB...`;
                        const url = await uploadToImgBB(file);
                        imageUrls.push(url);
                    }
                }

                loaderText.innerText = "ØªÛ†Ù…Ø§Ø±Ú©Ø±Ø¯Ù† Ù„Û• Ø¯Ø§ØªÛ•Ø¨Û•ÛŒØ³...";
                
                await addDoc(activitiesRef, {
                    name: name,
                    committee: document.getElementById('inpComm').value,
                    teacher: teacher,
                    date: document.getElementById('inpDate').value,
                    notes: document.getElementById('inpNotes').value,
                    images: imageUrls,
                    createdAt: new Date()
                });

                loader.style.display = 'none';
                loaderText.innerText = "Ø¯Ø§ØªØ§ Ø¯Û•Ù†ÛØ±Ø¯Ø±ÛØª... ØªÚ©Ø§ÛŒÛ• Ú†Ø§ÙˆÛ•Ú•ÛØ¨Û•"; 
                alert("âœ… Ø³Û•ÛŒÚ¤ Ú©Ø±Ø§!");
                closeEditor();
            } catch(err) {
                loader.style.display = 'none';
                loaderText.innerText = "Ø¯Ø§ØªØ§ Ø¯Û•Ù†ÛØ±Ø¯Ø±ÛØª... ØªÚ©Ø§ÛŒÛ• Ú†Ø§ÙˆÛ•Ú•ÛØ¨Û•";
                alert("Ù‡Û•ÚµÛ•: " + err.message);
            }
        };

        window.viewSavedReport = (id) => {
            const act = allActivities.find(a => a.id === id);
            if(!act) return;
            
            openEditor(); 
            document.getElementById('inpName').value = act.name;
            document.getElementById('inpComm').value = act.committee || '';
            document.getElementById('inpTeacher').value = act.teacher;
            document.getElementById('inpDate').value = act.date;
            document.getElementById('inpNotes').value = act.notes || '';
            
            for(let i=0; i<4; i++) {
                const imgEl = document.getElementById('img'+i);
                if(act.images && act.images[i]) {
                    imgEl.src = act.images[i];
                    imgEl.parentElement.classList.add('has-img');
                }
            }
            document.querySelector('.tool-btn.primary').style.display = 'none';
        };

        window.switchView = (v) => {
            document.getElementById('activitiesGrid').style.display = v==='archive'?'grid':'none';
            document.getElementById('archiveControls').style.display = v==='archive'?'flex':'none';
            document.getElementById('teachersGrid').style.display = v==='teachers'?'grid':'none';
            document.getElementById('btn-archive').classList.toggle('active', v==='archive');
            document.getElementById('btn-teachers').classList.toggle('active', v==='teachers');
        };
        window.deleteItem = async (id) => { if(confirm("Ø¯ÚµÙ†ÛŒØ§ÛŒØªØŸ")) await deleteDoc(doc(db, "activities", id)); };
        document.getElementById('searchBox').addEventListener('input', renderApp);
    </script>

    <script>
        function checkPassword() {
            if(document.getElementById('sitePassword').value === "2526") { 
                document.getElementById('securityOverlay').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
            } else { document.getElementById('errorMsg').style.display = 'block'; }
        }
        function toggleAdmin() {
            if(window.isAdmin) {
                window.isAdmin = false; document.getElementById('adminBtn').style.background="#eee";
                window.renderApp();
                alert("Ø¯Û•Ø±Ú†ÙˆÙˆÛŒØª.");
            } else {
                if(prompt("Ù¾Ø§Ø³Û†Ø±Ø¯ÛŒ Ø¦Û•Ø¯Ù…ÛŒÙ†:") === "2324") {
                    window.isAdmin = true; document.getElementById('adminBtn').style.background="#86efac";
                    window.renderApp();
                    alert("Ø¨Û•Ø®ÛØ±Ø¨ÛÛŒØª Ø¦Û•Ø¯Ù…ÛŒÙ†.");
                } else alert("Ù‡Û•ÚµÛ•ÛŒÛ•!");
            }
        }
    </script>
</body>
</html>

