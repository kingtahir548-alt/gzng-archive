<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø³ÛŒØ³ØªÛ•Ù…ÛŒ Ú•Ø§Ù¾Û†Ø±Øª Ùˆ Ø¦Û•Ø±Ø´ÛŒÙÛŒ Ú¯Ø²Ù†Ú¯</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #4f46e5; --bg-color: #f3f4f6; --card-bg: #ffffff;
            --text-dark: #1e293b; --text-gray: #64748b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Noto Sans Arabic', sans-serif; background-color: var(--bg-color); min-height: 100vh; padding: 10px; color: var(--text-dark); }
        
        .container { max-width: 1200px; margin: 0 auto; padding-bottom: 80px; display: none; }
        header { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); text-align: center; margin-bottom: 20px; position: relative; }
        h1 { font-size: 1.5em; margin-bottom: 5px; font-weight: 900; color: var(--primary); }
        
        .nav-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .tab-btn { background: white; border: 1px solid #ddd; padding: 8px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; font-family: inherit; transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        /* Ú¯Û†Ú•Ø§Ù†Ú©Ø§Ø±ÛŒ Ù„Û• Ø¨Û•Ø´ÛŒ Ú©Û†Ù†ØªÚ•Û†ÚµÛ•Ú©Ø§Ù† Ø¨Û† Ø¯ÙˆÙˆ Ø¯ÙˆÚ¯Ù…Û• */
        .controls { background: white; padding: 15px; border-radius: 16px; margin-bottom: 20px; display: flex; flex-direction: column; gap: 10px; }
        .search-box { padding: 12px; border-radius: 10px; border: 1px solid #ddd; font-family: inherit; width: 100%; }
        
        .buttons-row { display: flex; gap: 10px; flex-wrap: wrap; }
        
        .add-btn { 
            flex: 1; border: none; padding: 12px 20px; border-radius: 10px; 
            font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; 
            color: white; font-family: 'Noto Sans Arabic'; font-size: 0.95em;
        }
        .btn-upload { background: linear-gradient(135deg, var(--primary), #4338ca); }
        .btn-link { background: linear-gradient(135deg, #059669, #047857); }

        .activities-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .activity-card { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: 0.3s; }
        .activity-card:hover { transform: translateY(-5px); }
        .card-header { padding: 15px; border-bottom: 1px solid #eee; }
        .card-header h3 { font-size: 1.1em; margin-bottom: 5px; }
        .card-meta { font-size: 0.85em; color: var(--text-gray); display: flex; justify-content: space-between; }
        .card-imgs { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1px; height: 180px; overflow: hidden; background: #eee; }
        .card-imgs img { width: 100%; height: 100%; object-fit: cover; }
        .card-actions { padding: 10px; display: flex; gap: 10px; background: #fafafa; }
        .action-btn { flex: 1; padding: 8px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; font-family: inherit; font-size: 0.9em; }
        .btn-view { background: #e0e7ff; color: var(--primary); }
        .btn-del { background: #fee2e2; color: #ef4444; display: none; }

        .editor-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8fafc; z-index: 2000; overflow-y: auto; }
        .editor-modal.active { display: block; }
        
        .editor-header { background: white; padding: 15px; position: sticky; top: 0; z-index: 10; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .editor-tools { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .tool-btn { padding: 8px 15px; border-radius: 8px; border: 1px solid #ddd; background: white; cursor: pointer; font-family: inherit; font-weight: bold; font-size: 0.9em; white-space: nowrap; }
        .tool-btn.primary { background: var(--primary); color: white; border-color: var(--primary); }
        .tool-btn.danger { background: white; color: #ef4444; border-color: #ef4444; }
        .tool-btn.active-mode { background: #dcfce7; border-color: #22c55e; color: #15803d; }

        .paper-wrapper { padding: 20px; display: flex; justify-content: center; }
        .a4-paper { 
            width: 210mm; min-height: 297mm; background: white; padding: 15mm; 
            box-shadow: 0 0 20px rgba(0,0,0,0.1); position: relative; 
            color: black; direction: rtl; text-align: right; 
            display: flex; flex-direction: column;
        }
        
        @media print {
            body * { visibility: hidden; }
            .editor-modal, .editor-modal * { visibility: visible; }
            .editor-header, .editor-tools, .link-inputs-container { display: none !important; }
            .paper-wrapper { padding: 0; margin: 0; }
            .a4-paper { box-shadow: none; width: 100%; height: 100%; margin: 0; padding: 15mm; page-break-after: always; }
            .img-placeholder span { display: none; }
        }

        .rep-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #333; padding-bottom: 15px; margin-bottom: 20px; }
        .rep-logo { width: 70px; height: 70px; background: #f3f4f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid #ddd; }
        
        .rep-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; background: #f8fafc; padding: 15px; border-radius: 10px; border: 1px solid #e2e8f0; }
        .form-item label { display: block; font-size: 0.8em; color: #64748b; margin-bottom: 3px; }
        .form-input { width: 100%; border: none; background: transparent; font-family: inherit; font-weight: bold; font-size: 1em; border-bottom: 1px dashed #cbd5e1; padding: 2px; }
        .form-input:focus { outline: none; border-bottom-color: var(--primary); }

        .rep-images { display: grid; gap: 10px; margin-bottom: 20px; }
        .layout-landscape { grid-template-columns: 1fr 1fr; }
        .layout-landscape .img-slot { aspect-ratio: 16/9; }
        .layout-portrait { grid-template-columns: 1fr 1fr; }
        .layout-portrait .img-slot { aspect-ratio: 3/4; }

        .img-slot { 
            background: #f1f5f9; border: 2px dashed #cbd5e1; border-radius: 10px; 
            overflow: hidden; position: relative; cursor: pointer; display: flex; 
            align-items: center; justify-content: center; transition: 0.2s;
        }
        .img-slot:hover, .img-slot.drag-over { background: #e2e8f0; border-color: var(--primary); }
        .img-slot img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .img-slot.has-img img { display: block; }
        .img-slot.has-img .placeholder-text { display: none; }
        .placeholder-text { color: #94a3b8; font-size: 0.9em; text-align: center; pointer-events: none; }

        .rep-notes { margin-top: 10px; flex-grow: 1; }
        .rep-notes textarea { width: 100%; border: 1px solid #e2e8f0; border-radius: 10px; padding: 10px; font-family: inherit; resize: none; min-height: 200px; background: #fffbeb; font-size: 16px; line-height: 1.6; }

        .rep-footer { margin-top: auto; padding-top: 20px; text-align: center; border-top: 1px solid #eee; }
        .school-name-footer { font-size: 14px; font-weight: bold; color: #64748b; }

        .link-inputs-container { display: none; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; background: #fff7ed; padding: 15px; border-radius: 10px; border: 1px solid #ffedd5; }
        .link-input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace; direction: ltr; font-size: 12px; }

        #securityOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1e293b; z-index: 10000; display: flex; justify-content: center; align-items: center; }
        .auth-box { background: white; padding: 30px; border-radius: 20px; text-align: center; width: 90%; max-width: 350px; }
        .admin-btn { position: absolute; top: 20px; left: 20px; padding: 5px 10px; border-radius: 5px; border: none; cursor: pointer; font-family: inherit; font-size: 0.8em; background: #eee; }

        @media (max-width: 600px) {
            .a4-paper { width: 100%; padding: 10mm; min-height: auto; aspect-ratio: 210/297; }
            .editor-header { position: sticky; top: 0; }
            .paper-wrapper { padding: 10px 0; }
            .link-inputs-container { grid-template-columns: 1fr; }
            .buttons-row { flex-direction: column; }
        }
        
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:3000; display:none; flex-direction:column; justify-content:center; align-items:center; color:var(--primary); font-weight:bold;}
    </style>
</head>
<body>

    <div id="securityOverlay">
        <div class="auth-box">
            <h2>ğŸ”’ Ù¾Ø§Ø±ÛØ²Ø±Ø§Ùˆ</h2>
            <p style="color:#64748b; margin:10px 0;">ØªÚ©Ø§ÛŒÛ• ÙˆØ´Û•ÛŒ Ù†Ù‡ÛÙ†ÛŒ Ø¨Ù†ÙˆÙˆØ³Û•</p>
            <input type="password" id="sitePassword" style="width:100%; padding:10px; text-align:center; border:1px solid #ddd; border-radius:10px; margin-bottom:15px;" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢">
            <button onclick="checkPassword()" style="width:100%; padding:10px; background:var(--primary); color:white; border:none; border-radius:10px; font-weight:bold;">Ú†ÙˆÙˆÙ†Û•Ú˜ÙˆÙˆØ±Û•ÙˆÛ•</button>
            <p id="errorMsg" style="color:red; margin-top:10px; display:none;">Ù‡Û•ÚµÛ•ÛŒÛ•!</p>
        </div>
    </div>

    <div id="loader">Ø¯Ø§ØªØ§ Ø¯Û•Ù†ÛØ±Ø¯Ø±ÛØª... ØªÚ©Ø§ÛŒÛ• Ú†Ø§ÙˆÛ•Ú•ÛØ¨Û•</div>

    <div class="container" id="mainContent">
        <header>
            <button onclick="toggleAdmin()" class="admin-btn" id="adminBtn">ğŸ”‘ Ø¦Û•Ø¯Ù…ÛŒÙ†</button>
            <h1>ğŸ« Ù‚ÙˆØªØ§Ø¨Ø®Ø§Ù†Û•ÛŒ Ú¯Ø²Ù†Ú¯</h1>
            <p style="color:#64748b">Ø¦Û•Ø±Ø´ÛŒÙÛŒ Ú†Ø§Ù„Ø§Ú©ÛŒÛ•Ú©Ø§Ù†</p>
        </header>

        <div class="nav-tabs">
            <button onclick="switchView('archive')" class="tab-btn active" id="btn-archive">Ø¦Û•Ø±Ø´ÛŒÙ</button>
            <button onclick="switchView('teachers')" class="tab-btn" id="btn-teachers">Ù…Ø§Ù…Û†Ø³ØªØ§ÛŒØ§Ù†</button>
        </div>

        <!-- Ø¨Û•Ø´ÛŒ Ù†ÙˆÛÛŒ Ø¯ÙˆÚ¯Ù…Û•Ú©Ø§Ù† -->
        <div class="controls" id="archiveControls">
            <input type="text" class="search-box" id="searchBox" placeholder="Ú¯Û•Ú•Ø§Ù†...">
            
            <div class="buttons-row">
                <!-- Ø¯ÙˆÚ¯Ù…Û•ÛŒ Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù† Ø¨Û• ÙØ§ÛŒÙ„ (Upload) -->
                <button class="add-btn btn-upload" onclick="openEditor('file')">
                    ğŸ“ Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù† + Ú•Ø§Ù¾Û†Ø±Øª (Upload)
                </button>
                
                <!-- Ø¯ÙˆÚ¯Ù…Û•ÛŒ Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù† Ø¨Û• Ù„ÛŒÙ†Ú© (Link) -->
                <button class="add-btn btn-link" onclick="openEditor('link')">
                    ğŸ”— Ø²ÛŒØ§Ø¯Ú©Ø±Ø¯Ù† + Ú•Ø§Ù¾Û†Ø±Øª (Link)
                </button>
            </div>
        </div>

        <div class="activities-grid" id="activitiesGrid"></div>
        <div class="activities-grid" id="teachersGrid" style="display:none;"></div>
    </div>

    <!-- Report Editor -->
    <div class="editor-modal" id="editorModal">
        <div class="editor-header">
            <button onclick="closeEditor()" class="tool-btn danger">Ø¯Ø§Ø®Ø³ØªÙ†</button>
            <div class="editor-tools">
                <!-- Ø¯ÙˆÚ¯Ù…Û•ÛŒ Ú¯Û†Ú•ÛŒÙ†ÛŒ Ù…Û†Ø¯ Ù„ÛØ±Û• Ù…Ø§ÙˆÛ•ØªÛ•ÙˆÛ• Ø¨Û† Ù‡Û•Ù…ÙˆÙˆ Ø­Ø§ÚµÛ•ØªÛÚ©ØŒ Ø¨Û•ÚµØ§Ù… Ø¯ÙˆÚ¯Ù…Û• Ø³Û•Ø±Û•Ú©ÛŒÛŒÛ•Ú©Ø§Ù† Ø¨Ú•ÛŒØ§Ø± Ø¯Û•Ø¯Û•Ù† -->
                <button onclick="toggleImageMode()" id="btnImgMode" class="tool-btn">Ú¯Û†Ú•ÛŒÙ†ÛŒ Ù…Û†Ø¯</button>
                <button onclick="toggleLayout()" class="tool-btn">ğŸ”„ Ú¯Û†Ú•ÛŒÙ†ÛŒ ÙˆÛÙ†Û•</button>
                <button onclick="printReport()" class="tool-btn">ğŸ–¨ï¸ Ù¾Ø±ÛŒÙ†Øª</button>
                <button onclick="downloadAsImage()" class="tool-btn">â¬‡ï¸ Ø¯Ø§Ø¨Û•Ø²Ø§Ù†Ø¯Ù†</button>
                <button onclick="saveToArchive()" class="tool-btn primary">ğŸ’¾ Ø³Û•ÛŒÚ¤Ú©Ø±Ø¯Ù†</button>
            </div>
        </div>

        <div class="paper-wrapper">
            <div class="a4-paper" id="reportPaper">
                
                <div class="rep-header">
                    <div>
                        <h1 style="font-size:22px; margin:0; color:black;">Ù‚ÙˆØªØ§Ø¨Ø®Ø§Ù†Û•ÛŒ Ú¯Ø²Ù†Ú¯</h1>
                        <p style="margin:5px 0 0 0; font-size:14px; color:#555;">ÙÛ†Ø±Ù…ÛŒ Ú•Ø§Ù¾Û†Ø±ØªÛŒ Ú†Ø§Ù„Ø§Ú©ÛŒ</p>
                    </div>
                    <div class="rep-logo">LOGO</div>
                </div>

                <div class="rep-form-grid">
                    <div class="form-item">
                        <label>Ø¨Ø§Ø¨Û•Øª / Ú†Ø§Ù„Ø§Ú©ÛŒ</label>
                        <input type="text" class="form-input" id="inpName" placeholder="Ø¨Ù†ÙˆÙˆØ³Û•...">
                    </div>
                    <div class="form-item">
                        <label>Ù„ÛŒÚ˜Ù†Û•</label>
                        <input type="text" class="form-input" id="inpComm" placeholder="Ø¨Ù†ÙˆÙˆØ³Û•...">
                    </div>
                    <div class="form-item">
                        <label>Ù…Ø§Ù…Û†Ø³ØªØ§ / Ø³Û•Ø±Ù¾Û•Ø±Ø´ØªÛŒØ§Ø±</label>
                        <input type="text" class="form-input" id="inpTeacher" placeholder="Ø¨Ù†ÙˆÙˆØ³Û•...">
                    </div>
                    <div class="form-item">
                        <label>Ø¨Û•Ø±ÙˆØ§Ø±</label>
                        <input type="date" class="form-input" id="inpDate" style="text-align:right;">
                    </div>
                </div>

                <!-- Ø¨Û•Ø´ÛŒ Ù„ÛŒÙ†Ú©Û•Ú©Ø§Ù† -->
                <div class="link-inputs-container" id="linkInputsArea">
                    <input type="text" class="link-input" placeholder="Ù„ÛŒÙ†Ú©ÛŒ ÙˆÛÙ†Û•ÛŒ Ù¡ (ImgBB URL)..." oninput="updateLinkPreview(0, this.value)">
                    <input type="text" class="link-input" placeholder="Ù„ÛŒÙ†Ú©ÛŒ ÙˆÛÙ†Û•ÛŒ Ù¢ (ImgBB URL)..." oninput="updateLinkPreview(1, this.value)">
                    <input type="text" class="link-input" placeholder="Ù„ÛŒÙ†Ú©ÛŒ ÙˆÛÙ†Û•ÛŒ Ù£ (ImgBB URL)..." oninput="updateLinkPreview(2, this.value)">
                    <input type="text" class="link-input" placeholder="Ù„ÛŒÙ†Ú©ÛŒ ÙˆÛÙ†Û•ÛŒ Ù¤ (ImgBB URL)..." oninput="updateLinkPreview(3, this.value)">
                </div>

                <!-- ÙˆÛÙ†Û•Ú©Ø§Ù† -->
                <div class="rep-images layout-landscape" id="imgContainer">
                    <div class="img-slot" onclick="triggerFile(0)" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)" ondrop="handleDrop(event, 0)">
                        <img id="img0">
                        <div class="placeholder-text">ÙˆÛÙ†Û•ÛŒ Ù¡<br>ğŸ“¸</div>
                    </div>
                    <div class="img-slot" onclick="triggerFile(1)" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)" ondrop="handleDrop(event, 1)">
                        <img id="img1">
                        <div class="placeholder-text">ÙˆÛÙ†Û•ÛŒ Ù¢<br>ğŸ“¸</div>
                    </div>
                    <div class="img-slot" onclick="triggerFile(2)" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)" ondrop="handleDrop(event, 2)">
                        <img id="img2">
                        <div class="placeholder-text">ÙˆÛÙ†Û•ÛŒ Ù£<br>ğŸ“¸</div>
                    </div>
                    <div class="img-slot" onclick="triggerFile(3)" ondragover="allowDrop(event)" ondragleave="leaveDrop(event)" ondrop="handleDrop(event, 3)">
                        <img id="img3">
                        <div class="placeholder-text">ÙˆÛÙ†Û•ÛŒ Ù¤<br>ğŸ“¸</div>
                    </div>
                </div>
                <input type="file" id="hiddenFileInput" accept="image/*" style="display:none">

                <div class="rep-notes">
                    <label style="font-size:0.9em; font-weight:bold;">ØªÛØ¨ÛŒÙ†ÛŒ Ùˆ ÙˆØ±Ø¯Û•Ú©Ø§Ø±ÛŒ:</label>
                    <textarea id="inpNotes" placeholder="Ù„ÛØ±Û• Ø¨Ù†ÙˆÙˆØ³Û•..."></textarea>
                </div>

                <div class="rep-footer">
                    <p class="school-name-footer">Ù‚ÙˆØªØ§Ø¨Ø®Ø§Ù†Û•ÛŒ Ú¯Ø²Ù†Ú¯ÛŒ Ø¦ÛŒÙ†Ú¯Ù„ÛŒØ²ÛŒ Ù†Ø§Ø­Ú©ÙˆÙ…ÛŒ</p>
                </div>

            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAr_JHCa5BbM5RJ9KCp0IBom1rdAgVX4CM",
            authDomain: "gzng-f4273.firebaseapp.com",
            projectId: "gzng-f4273",
            storageBucket: "gzng-f4273.firebasestorage.app",
            messagingSenderId: "417779309632",
            appId: "1:417779309632:web:6ed119d26baa35822cd3a5",
            measurementId: "G-B6V0CHGQV6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const activitiesRef = collection(db, "activities");

        let allActivities = [];
        window.isAdmin = false;
        window.localFiles = [null, null, null, null]; 
        window.linkUrls = ["", "", "", ""];
        window.currentSlot = 0;
        window.useLinks = false; 

        const q = query(activitiesRef, orderBy("date", "desc"));
        onSnapshot(q, (snapshot) => {
            allActivities = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderApp();
        });

        function renderApp() {
            const grid = document.getElementById('activitiesGrid');
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            
            const displayList = allActivities.filter(a => 
                a.name.toLowerCase().includes(searchTerm) || 
                a.teacher.toLowerCase().includes(searchTerm)
            );

            grid.innerHTML = displayList.map(act => `
                <div class="activity-card">
                    <div class="card-header">
                        <h3>${act.name}</h3>
                        <div class="card-meta"><span>ğŸ‘¤ ${act.teacher}</span><span>ğŸ“… ${act.date}</span></div>
                    </div>
                    <div class="card-imgs">
                        ${act.images ? act.images.slice(0,4).map(url => `<img src="${url}">`).join('') : ''}
                    </div>
                    <div class="card-actions">
                        <button class="action-btn btn-view" onclick="viewSavedReport('${act.id}')">ğŸ“„ Ú•Ø§Ù¾Û†Ø±Øª</button>
                        ${window.isAdmin ? `<button class="action-btn btn-del" style="display:block" onclick="deleteItem('${act.id}')">ğŸ—‘ï¸ Ø³Ú•ÛŒÙ†Û•ÙˆÛ•</button>` : ''}
                    </div>
                </div>
            `).join('');
            
            const tGrid = document.getElementById('teachersGrid');
            const tMap = {};
            allActivities.forEach(a => { const t = a.teacher.trim(); tMap[t] = (tMap[t] || 0) + 1; });
            tGrid.innerHTML = Object.keys(tMap).map(t => `
                <div class="activity-card" style="padding:20px; text-align:center;">
                    <div style="font-size:40px; margin-bottom:10px">ğŸ‘¤</div>
                    <h3>${t}</h3>
                    <p style="color:#666">${tMap[t]} Ú†Ø§Ù„Ø§Ú©ÛŒ</p>
                </div>
            `).join('');
        }

        // Updated openEditor to handle different modes
        window.openEditor = (mode) => {
            document.getElementById('inpName').value = '';
            document.getElementById('inpComm').value = '';
            document.getElementById('inpTeacher').value = '';
            document.getElementById('inpDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('inpNotes').value = '';
            
            // Reset images
            window.localFiles = [null, null, null, null];
            window.linkUrls = ["", "", "", ""];
            
            // Set mode based on button clicked
            if (mode === 'link') {
                window.useLinks = true;
            } else {
                window.useLinks = false;
            }
            
            updateImageModeUI();
            
            for(let i=0; i<4; i++) {
                document.getElementById('img'+i).src = '';
                document.getElementById('img'+i).parentElement.classList.remove('has-img');
                document.querySelectorAll('.link-input')[i].value = '';
            }
            document.getElementById('editorModal').classList.add('active');
        };

        window.closeEditor = () => document.getElementById('editorModal').classList.remove('active');

        window.toggleImageMode = () => {
            window.useLinks = !window.useLinks;
            updateImageModeUI();
        };

        function updateImageModeUI() {
            const btn = document.getElementById('btnImgMode');
            const inputs = document.getElementById('linkInputsArea');
            
            if (window.useLinks) {
                btn.classList.add('active-mode');
                btn.innerText = "ğŸ“‚ Ú¯Û†Ú•ÛŒÙ† Ø¨Û† ÙØ§ÛŒÙ„ (Upload)";
                inputs.style.display = 'grid';
            } else {
                btn.classList.remove('active-mode');
                btn.innerText = "ğŸ”— Ú¯Û†Ú•ÛŒÙ† Ø¨Û† Ù„ÛŒÙ†Ú© (ImgBB)";
                inputs.style.display = 'none';
            }
        }

        window.updateLinkPreview = (index, url) => {
            window.linkUrls[index] = url;
            const imgEl = document.getElementById('img' + index);
            if (url) {
                imgEl.src = url;
                imgEl.parentElement.classList.add('has-img');
            } else {
                imgEl.src = '';
                imgEl.parentElement.classList.remove('has-img');
            }
        };

        window.toggleLayout = () => {
            const c = document.getElementById('imgContainer');
            if(c.classList.contains('layout-landscape')) {
                c.classList.remove('layout-landscape');
                c.classList.add('layout-portrait');
            } else {
                c.classList.remove('layout-portrait');
                c.classList.add('layout-landscape');
            }
        };

        window.triggerFile = (index) => {
            if (window.useLinks) return; 
            window.currentSlot = index;
            document.getElementById('hiddenFileInput').click();
        };

        window.allowDrop = (e) => {
            if (window.useLinks) return;
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        };

        window.leaveDrop = (e) => {
            e.currentTarget.classList.remove('drag-over');
        }

        window.handleDrop = (e, index) => {
            if (window.useLinks) return;
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if(file && file.type.startsWith('image/')) {
                processFile(file, index);
            }
        };

        function processFile(file, index) {
            window.localFiles[index] = file;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const imgEl = document.getElementById('img' + index);
                imgEl.src = ev.target.result;
                imgEl.parentElement.classList.add('has-img');
            };
            reader.readAsDataURL(file);
        }

        document.getElementById('hiddenFileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(file) processFile(file, window.currentSlot);
            e.target.value = '';
        });

        window.printReport = () => window.print();
        
        window.downloadAsImage = () => {
            const el = document.querySelector(".a4-paper");
            html2canvas(el, { scale: 2, useCORS: true }).then(canvas => {
                const a = document.createElement('a');
                a.download = 'Gzng_Report.jpg';
                a.href = canvas.toDataURL('image/jpeg', 0.9);
                a.click();
            }).catch(e => alert("Ù‡Û•ÚµÛ•: " + e));
        };

        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 1000; 
                        const scaleSize = MAX_WIDTH / img.width;
                        if (img.width > MAX_WIDTH) {
                            canvas.width = MAX_WIDTH;
                            canvas.height = img.height * scaleSize;
                        } else {
                            canvas.width = img.width;
                            canvas.height = img.height;
                        }
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        canvas.toBlob((blob) => { resolve(blob); }, 'image/jpeg', 0.6);
                    };
                    img.onerror = (err) => reject(err);
                };
                reader.onerror = (err) => reject(err);
            });
        }

        window.saveToArchive = async () => {
            const name = document.getElementById('inpName').value;
            const teacher = document.getElementById('inpTeacher').value;
            if(!name || !teacher) { alert("ØªÚ©Ø§ÛŒÛ• Ù†Ø§Ùˆ Ùˆ Ù…Ø§Ù…Û†Ø³ØªØ§ Ø¨Ù†ÙˆÙˆØ³Û•!"); return; }

            const loader = document.getElementById('loader');
            loader.style.display = 'flex';

            try {
                let imageUrls = [];
                
                if (window.useLinks) {
                    imageUrls = window.linkUrls.filter(url => url.trim() !== "");
                } else {
                    for(let i=0; i<4; i++) {
                        const file = window.localFiles[i];
                        if(file) {
                            loader.innerText = `ÙˆÛÙ†Û•ÛŒ ${i+1} Ø¨Ú†ÙˆÙˆÚ© Ø¯Û•Ú©Ø±ÛØªÛ•ÙˆÛ•...`;
                            const compressedFile = await compressImage(file);
                            loader.innerText = `ÙˆÛÙ†Û•ÛŒ ${i+1} Ø¯Û•Ù†ÛØ±Ø¯Ø±ÛØª...`;
                            const storageRef = ref(storage, 'images/' + Date.now() + '-' + i + '.jpg');
                            await uploadBytes(storageRef, compressedFile);
                            const url = await getDownloadURL(storageRef);
                            imageUrls.push(url);
                        }
                    }
                }

                await addDoc(activitiesRef, {
                    name: name,
                    committee: document.getElementById('inpComm').value,
                    teacher: teacher,
                    date: document.getElementById('inpDate').value,
                    notes: document.getElementById('inpNotes').value,
                    images: imageUrls,
                    createdAt: new Date()
                });

                loader.style.display = 'none';
                loader.innerText = "Ø¯Ø§ØªØ§ Ø¯Û•Ù†ÛØ±Ø¯Ø±ÛØª... ØªÚ©Ø§ÛŒÛ• Ú†Ø§ÙˆÛ•Ú•ÛØ¨Û•"; 
                alert("âœ… Ø³Û•ÛŒÚ¤ Ú©Ø±Ø§!");
                closeEditor();
            } catch(err) {
                loader.style.display = 'none';
                loader.innerText = "Ø¯Ø§ØªØ§ Ø¯Û•Ù†ÛØ±Ø¯Ø±ÛØª... ØªÚ©Ø§ÛŒÛ• Ú†Ø§ÙˆÛ•Ú•ÛØ¨Û•";
                alert("Ù‡Û•ÚµÛ• Ù„Û• Ø³Û•ÛŒÚ¤Ú©Ø±Ø¯Ù†: " + err.message);
            }
        };

        window.viewSavedReport = (id) => {
            const act = allActivities.find(a => a.id === id);
            if(!act) return;
            
            openEditor(); // By default opens in file mode, but we'll switch if needed or just show images
            
            document.getElementById('inpName').value = act.name;
            document.getElementById('inpComm').value = act.committee || '';
            document.getElementById('inpTeacher').value = act.teacher;
            document.getElementById('inpDate').value = act.date;
            document.getElementById('inpNotes').value = act.notes || '';
            
            // Pre-fill images
            for(let i=0; i<4; i++) {
                const imgEl = document.getElementById('img'+i);
                if(act.images && act.images[i]) {
                    imgEl.src = act.images[i];
                    imgEl.parentElement.classList.add('has-img');
                }
            }
            document.querySelector('.tool-btn.primary').style.display = 'none';
        };

        window.switchView = (v) => {
            document.getElementById('activitiesGrid').style.display = v==='archive'?'grid':'none';
            document.getElementById('archiveControls').style.display = v==='archive'?'flex':'none';
            document.getElementById('teachersGrid').style.display = v==='teachers'?'grid':'none';
            document.getElementById('btn-archive').classList.toggle('active', v==='archive');
            document.getElementById('btn-teachers').classList.toggle('active', v==='teachers');
        };
        window.deleteItem = async (id) => { if(confirm("Ø¯ÚµÙ†ÛŒØ§ÛŒØªØŸ")) await deleteDoc(doc(db, "activities", id)); };
        document.getElementById('searchBox').addEventListener('input', renderApp);
    </script>

    <script>
        function checkPassword() {
            if(document.getElementById('sitePassword').value === "2526") { 
                document.getElementById('securityOverlay').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
            } else { document.getElementById('errorMsg').style.display = 'block'; }
        }
        function toggleAdmin() {
            if(window.isAdmin) {
                window.isAdmin = false; document.getElementById('adminBtn').style.background="#eee";
                window.renderApp();
                alert("Ø¯Û•Ø±Ú†ÙˆÙˆÛŒØª.");
            } else {
                if(prompt("Ù¾Ø§Ø³Û†Ø±Ø¯ÛŒ Ø¦Û•Ø¯Ù…ÛŒÙ†:") === "2324") {
                    window.isAdmin = true; document.getElementById('adminBtn').style.background="#86efac";
                    window.renderApp();
                    alert("Ø¨Û•Ø®ÛØ±Ø¨ÛÛŒØª Ø¦Û•Ø¯Ù…ÛŒÙ†.");
                } else alert("Ù‡Û•ÚµÛ•ÛŒÛ•!");
            }
        }
    </script>
</body>
</html>
